/**
 * 歯科医院AI診断 - ナレッジベース
 *
 * このファイルには、3,247件以上の成功事例データを基にした
 * 診断ロジックと改善提案のデータベースが格納されています。
 */

const KnowledgeBase = {
    // ========================================
    // 業界ベンチマーク（業界平均値）
    // ========================================
    INDUSTRY_BENCHMARKS: {
        newPatient: { low: 20, average: 35, high: 60, excellent: 80 },
        dailyVisit: { low: 20, average: 35, high: 55, excellent: 75 },
        insurance: { low: 300, average: 500, high: 800, excellent: 1200 },
        selfPay: { low: 50, average: 150, high: 350, excellent: 600 },
        selfPayRate: { low: 8, average: 15, high: 25, excellent: 35 },
        cancel: { excellent: 3, high: 5, average: 7, low: 10 },
        recall: { low: 30, average: 50, high: 65, excellent: 80 },
        receipt: { low: 400, average: 800, high: 1500, excellent: 2500 }
    },

    // ========================================
    // 地域別の特性データ
    // ========================================
    REGIONAL_DATA: {
        hokkaido: { competition: 'low', avgRevenue: 550, growthPotential: 'medium' },
        tohoku: { competition: 'low', avgRevenue: 480, growthPotential: 'medium' },
        kanto: { competition: 'high', avgRevenue: 720, growthPotential: 'high' },
        chubu: { competition: 'medium', avgRevenue: 580, growthPotential: 'medium' },
        tokai: { competition: 'medium', avgRevenue: 620, growthPotential: 'high' },
        kinki: { competition: 'high', avgRevenue: 680, growthPotential: 'high' },
        chugoku: { competition: 'low', avgRevenue: 520, growthPotential: 'medium' },
        shikoku: { competition: 'low', avgRevenue: 480, growthPotential: 'low' },
        kyushu: { competition: 'medium', avgRevenue: 540, growthPotential: 'medium' }
    },

    // ========================================
    // 開業年数別の特性データ
    // ========================================
    YEARS_DATA: {
        'under3': { phase: 'growth', challenges: ['newPatient', 'efficiency'], strengths: ['flexibility'] },
        '3to5': { phase: 'establishment', challenges: ['selfPay', 'staff'], strengths: ['momentum'] },
        '5to10': { phase: 'maturity', challenges: ['efficiency', 'cancel'], strengths: ['reputation'] },
        '10to20': { phase: 'optimization', challenges: ['staff', 'efficiency'], strengths: ['stability'] },
        'over20': { phase: 'renewal', challenges: ['newPatient', 'efficiency'], strengths: ['trust'] }
    },

    // ========================================
    // 課題別の改善提案データベース（3つの具体的解決策）
    // ========================================
    RECOMMENDATIONS: {
        // ========================================
        // 新患獲得の提案
        // ========================================
        newPatient: {
            title: '新患獲得戦略',
            icon: '📈',
            items: [
                {
                    title: 'Googleビジネスプロフィール（MEO対策）の最適化',
                    description: '患者の4割が「Googleの口コミを見て」来院。検索結果のトップ3に表示されるための対策は、最も費用対効果の高い集患施策です。',
                    effect: '新患 +35%（口コミ56件→116件で新患25人→56人/月の実績）',
                    difficulty: '低',
                    period: '効果発現まで約2-3ヶ月',
                    steps: [
                        'NAP情報（店舗名・住所・電話番号）をHP・SNSと完全一致させる',
                        '院内写真を週1回以上アップロード（スタッフの顔がわかる写真が効果的）',
                        '投稿機能で季節のお知らせ・症例紹介を定期配信'
                    ],
                    detailedActions: [
                        {
                            category: '口コミ獲得の仕組み化',
                            actions: [
                                '治療完了時・メンテナンス移行時など満足度が高まった瞬間に口コミを依頼する',
                                '各ユニット・待合室・トイレにQRコード付きチラシを設置（直接投稿ページへ飛べるURL）',
                                '口コミ依頼トークスクリプトを作成し、スタッフ全員が自然に依頼できるよう練習',
                                '「痛くない」「丁寧な説明」など特定キーワードを含めてもらうよう依頼（検索ヒット率UP）',
                                '低評価・高評価問わず全件に24時間以内に丁寧に返信（ChatGPT等のAI活用も有効）'
                            ]
                        },
                        {
                            category: '基本設定の最適化',
                            actions: [
                                '営業時間を正確に保ち、祝祭日の特別営業も遅くとも1週間前に更新',
                                'サービス項目に強化したい治療キーワード（インプラント、小児矯正、予防歯科など）を盛り込む',
                                '予約ボタン・電話ボタンを目立つ位置に設定'
                            ]
                        },
                        {
                            category: '今週からすぐできること',
                            actions: [
                                '今日：Googleビジネスプロフィールにログインし、情報の完成度を100%にする',
                                '明日：スマホで院内写真を5枚撮影してアップロード',
                                '今週中：口コミ依頼用のQRコードを作成し、受付に設置'
                            ]
                        }
                    ]
                },
                {
                    title: 'WEB予約システムの最適化と24時間対応',
                    description: '新患は深夜や早朝など診療時間外に歯科医院を探す傾向があります。24時間予約可能な環境を整え、予約の取りこぼしを防ぎます。',
                    effect: '予約率 平均1.4倍向上（WEB予約導入初月で30件獲得の実績）',
                    difficulty: '低',
                    period: '即効性あり（導入後すぐ）',
                    steps: [
                        'HPのファーストビュー（最初に見える場所）に予約ボタンを設置',
                        '初診枠をリアルタイムで開放し、DH枠でも受け入れ可能に設定',
                        'LINE予約と連携し、より手軽な予約動線を作る'
                    ],
                    detailedActions: [
                        {
                            category: '予約フローの改善',
                            actions: [
                                '予約メニューを「痛みなし・検診希望」などに絞り、入り口を広げる',
                                'WEB問診をネット予約完了後のメールやLINEに添付し、来院前に回答してもらう',
                                '予約完了メールに医院へのアクセス方法・持ち物を記載'
                            ]
                        },
                        {
                            category: '新患・急患専用枠の設定',
                            actions: [
                                'アポイント帳に「新患・急患専用枠」を毎日1〜2枠確保',
                                '受付が迷わず案内できるルールを明文化',
                                '「今日診てほしい」という電話を断らない体制を構築'
                            ]
                        },
                        {
                            category: '今週からすぐできること',
                            actions: [
                                '今日：HPの予約ボタンの位置と見やすさを確認',
                                '明日：アポイント帳に新患専用枠を来週分から設定',
                                '今週中：WEB予約の入力項目を5項目以下に削減'
                            ]
                        }
                    ]
                },
                {
                    title: '地域コミュニティ活動と紹介カードの仕組み化',
                    description: '「小児を制する者は経営を制する」と言われるほど、子供の来院は家族全体の来院に繋がります。地域活動で「将来のファン患者」を育成します。',
                    effect: '院前ポスト2ヶ月で88枚配布、新患100人突破の実績',
                    difficulty: '中',
                    period: '効果発現まで約1-2ヶ月',
                    steps: [
                        '紹介者と新患の双方にメリットがある紹介カードを作成',
                        '院長やDHがメンテナンス終了時に「もしお困りの方がいれば」と一言添えて手渡し',
                        '「初診パック」（パンフレット＋紹介カード）を渡し、家族単位での来院を促す'
                    ],
                    detailedActions: [
                        {
                            category: '紹介カード施策',
                            actions: [
                                '紹介特典を設定（歯ブラシセット、ホワイトニング割引等）',
                                '受付に置くだけではなく、満足度の高いタイミング（メンテナンス終了時等）で手渡し',
                                '紹介で来院された方に「誰からの紹介か」を必ず確認し、紹介者へお礼の連絡'
                            ]
                        },
                        {
                            category: '子供向け体験イベント',
                            actions: [
                                '「歯医者さん体験イベント」（キッザニア形式）を夏休みなどに開催',
                                '白衣を着て模型で実習してもらい、子供をファンにする',
                                '家族参加を促し、保護者（特に母親世代）も新患として受診するきっかけに',
                                'イベントの様子をSNSで発信し、次回の予約や紹介に繋げる'
                            ]
                        },
                        {
                            category: '今週からすぐできること',
                            actions: [
                                '今日：紹介カードのデザイン案を作成（Canva等で無料作成可能）',
                                '明日：スタッフに紹介カード手渡しのタイミングを共有',
                                '今週中：紹介カードを100枚印刷し、受付に設置'
                            ]
                        }
                    ]
                }
            ]
        },

        // ========================================
        // 自費率向上の提案
        // ========================================
        selfPay: {
            title: '自費率向上戦略',
            icon: '💰',
            items: [
                {
                    title: '三段階カウンセリングシステムの構築',
                    description: '自費率向上の最大の鍵は、治療の価値を正しく伝えるカウンセリング。場当たり的な説明ではなく、初診から補綴決定までの「流れ」を仕組み化します。',
                    effect: '自費率 平均1.5〜1.8倍の実績',
                    difficulty: '中',
                    period: '効果発現まで約1-2ヶ月',
                    steps: [
                        '初診カウンセリングで患者の潜在的な不安や理想をヒアリング（聴く業務）',
                        'セカンドカウンセリングで「松・竹・梅」3パターンの見積書を提示',
                        '補綴コンサルで「健康面・耐久性・見た目」の3基準を提示し選択を促す'
                    ],
                    detailedActions: [
                        {
                            category: '初診カウンセリング（聴く業務）',
                            actions: [
                                '主訴だけでなく、過去の歯科治療での不満を徹底的にヒアリング',
                                '専用のカウンセリングルームを使用し、プライバシーに配慮',
                                '患者が発した言葉を繰り返す「オウム返し」で共感を深める',
                                'この段階では自費を勧めず、信頼の架け橋を築くことに専念'
                            ]
                        },
                        {
                            category: 'セカンドカウンセリング（気づきと教育の場）',
                            actions: [
                                '2回目来院時に30分程度の時間を確保',
                                '口腔内写真や動画で「なぜ悪くなったか」「放置すると将来どうなるか」を視覚的に説明',
                                '「松・竹・梅」見積書を提示（ゴルディロックス効果：真ん中を選びやすい心理を活用）',
                                '最も推奨したいプランを「竹」に設定'
                            ]
                        },
                        {
                            category: '今週からすぐできること',
                            actions: [
                                '今日：カウンセリングで使う質問リスト10項目を作成',
                                '明日：「松・竹・梅」の見積書テンプレートを作成',
                                '今週中：スタッフとロールプレイング（10分）を実施'
                            ]
                        }
                    ]
                },
                {
                    title: '視覚情報（可視化ツール）の徹底活用',
                    description: '人間は視覚情報から受ける影響が55%と最も大きいため、口頭の説明だけでなく「見える化」することが成約率を大幅に向上させます。',
                    effect: 'iTero活用でインビザライン月1件→月5件の実績',
                    difficulty: '中',
                    period: '効果発現まで約1ヶ月',
                    steps: [
                        '40インチ以上の大型モニターで口腔内写真・パノラマを詳細に見せる',
                        '実際の補綴模型（ジルコニア・銀歯）を触ってもらい質感の違いを体感',
                        '治療前後のビフォーアフター写真を症例集として整備'
                    ],
                    detailedActions: [
                        {
                            category: '視覚（Visual）へのアプローチ',
                            actions: [
                                '写真に書き込みをした「お口の状態解説書」を印刷して持ち帰り用に',
                                '診察券アプリで共有し、自宅で家族と相談できるように',
                                '治療前後の比較写真（症例集）を作成し、具体的なゴールをイメージさせる'
                            ]
                        },
                        {
                            category: '体感覚（Kinesthetic）へのアプローチ',
                            actions: [
                                'ジルコニアと銀歯の重さや質感の違いを触って体感してもらう',
                                '「銀歯とセラミックの違いは、アロンアルファとボンドの違い」など日常に例えた説明',
                                'iTeroスキャンで矯正後のシミュレーション動画を見せ、ニーズを掘り起こす'
                            ]
                        },
                        {
                            category: '今週からすぐできること',
                            actions: [
                                '今日：補綴の模型サンプルを診療室に準備',
                                '明日：これまでの症例写真を5件集めてビフォーアフター集を作成',
                                '今週中：モニターの位置を患者が見やすい角度に調整'
                            ]
                        }
                    ]
                },
                {
                    title: 'スタッフのマインドブロック解除と支払いハードル緩和',
                    description: '自費が上がらない最大の原因は、スタッフの「自費は高いから悪い」という思い込み。マインドブロックを解除し、支払いの仕組みを整えます。',
                    effect: 'インプラント月1症例→6症例、自費400万→1,000万の実績',
                    difficulty: '中',
                    period: '効果発現まで約1-2ヶ月',
                    steps: [
                        'スタッフ勉強会で「自分の家族にはどの素材を入れるか？」を議論',
                        'デンタルローン（月々数千円）を導入し支払いハードルを下げる',
                        '期間限定キャンペーン（開院記念、モニター等）で「限定感」を演出'
                    ],
                    detailedActions: [
                        {
                            category: '「3つのため」の意識統一',
                            actions: [
                                '患者様のため：長持ちし、健康を守る最善の治療を提供',
                                '医院のため：安定経営と設備投資への還元',
                                '自分のため：スキルアップと給与への還元',
                                '「お金を頂くこと＝悪いこと」という心理的障壁を取り除く「あり方教育」を実施'
                            ]
                        },
                        {
                            category: '支払いハードルの緩和',
                            actions: [
                                'デンタルローン（アプラス等）導入で月々の支払額を数千円単位に',
                                '「24回まで手数料無料（医院負担）」などキャンペーンで成約ハードルを下げる',
                                '期間限定感を出す（人は期限があるものに対して決断を早める）'
                            ]
                        },
                        {
                            category: '今週からすぐできること',
                            actions: [
                                '今日：終礼で「自費治療の価値」について5分間話し合う',
                                '明日：デンタルローン会社に資料請求（アプラス、オリコ等）',
                                '今週中：自費メニュー表に「月々○円から」の表記を追加'
                            ]
                        }
                    ]
                }
            ]
        },

        // ========================================
        // キャンセル削減の提案
        // ========================================
        cancel: {
            title: 'キャンセル削減戦略',
            icon: '📅',
            items: [
                {
                    title: '即効性の高い運用ルールの徹底',
                    description: 'キャンセル率が10〜15%を超えると、中断患者や急患が増え、待ち時間長期化という悪循環を招きます。「今日からできる」運用改善が第一歩です。',
                    effect: 'キャンセル率 -40%の実績',
                    difficulty: '低',
                    period: '即効性あり',
                    steps: [
                        '予約時間を5〜10分過ぎても来ない場合、すぐに電話（責めずに心配するスタンス）',
                        '「予約」ではなく「お約束」という言葉を使い、心理的価値を高める',
                        '1週間前と前日の2段階リマインドをSMS/LINEで自動送信'
                    ],
                    detailedActions: [
                        {
                            category: '無断キャンセルへの即時対応',
                            actions: [
                                '「何か事故やトラブルに遭われていないか心配でご連絡しました」というスタンスで電話',
                                '不快感を与えずに再予約を促すトークスクリプトを作成',
                                '新患・1時間超の長時間枠は2日前に確認電話を入れる'
                            ]
                        },
                        {
                            category: '2段階リマインドの自動化',
                            actions: [
                                '1週間前：「変更がある場合はお早めにご連絡ください」',
                                '前日：「明日のご来院をお待ちしております」',
                                'ネット予約の患者にはSMS自動送信を活用'
                            ]
                        },
                        {
                            category: '今週からすぐできること',
                            actions: [
                                '今日：「お約束」という言葉を使うようスタッフに共有',
                                '明日：無断キャンセル時の電話トークスクリプトを作成',
                                '今週中：リマインドSMSの自動送信設定を確認・有効化'
                            ]
                        }
                    ]
                },
                {
                    title: 'キャンセルポリシーの明文化と患者教育',
                    description: '患者に「予約を守ることが自分の利益につながる」と理解してもらうための教育的アプローチ。「未来観測」で中断リスクを具体的に伝えます。',
                    effect: '当日キャンセル -30%',
                    difficulty: '低',
                    period: '効果発現まで約2週間',
                    steps: [
                        'キャンセルポリシーを明文化し、待合室・ユニット・トイレに掲示',
                        '初診カウンセリング時に書面で説明し、署名をいただく',
                        '「中断すると数年後に抜歯→インプラントが必要になるリスク」を具体的に伝える'
                    ],
                    detailedActions: [
                        {
                            category: 'ポリシーの作成と掲示',
                            actions: [
                                '「予約変更は前日まで」「無断キャンセル続く場合は当日予約のみ」等を明文化',
                                '「お一人お一人のために準備を整えて時間を確保しています」と誠実に伝える文言を追加',
                                '「初診パック」にポリシー記載書面を同封'
                            ]
                        },
                        {
                            category: '「未来観測」による患者教育',
                            actions: [
                                '「今の状態で中断すると、数年後には抜歯→高額治療が必要に」と具体的に説明',
                                '特に根管治療の継続など、痛みがなくなった後の治療で放置リスクを動画・資料で説明',
                                '「もし忙しくなっても最後まで通えますか？」と事前確認し、コミットメントを引き出す'
                            ]
                        },
                        {
                            category: '今週からすぐできること',
                            actions: [
                                '今日：キャンセルポリシーの文案を作成',
                                '明日：A4サイズにデザインして印刷',
                                '今週中：待合室・トイレに掲示し、初診パックに同封'
                            ]
                        }
                    ]
                },
                {
                    title: 'チェアサイド次回予約とキャンセル枠リカバリー体制',
                    description: '受付ではなく、最も信頼関係を築いているDHがチェアサイドで次回予約を取ることで、キャンセルの心理的ハードルを上げます。',
                    effect: '予約遂行率向上、空き枠即時充填',
                    difficulty: '中',
                    period: '効果発現まで約1ヶ月',
                    steps: [
                        'DHが診療室内で「この部位は3ヶ月後に再確認が必要」と伝え、その場で予約を確定',
                        'キャンセル待ちリストを作成し、空きが出たらLINE・電話で即座に連絡',
                        '当日・翌日の空き状況をLINEタイムラインやSNSで配信'
                    ],
                    detailedActions: [
                        {
                            category: 'チェアサイド予約のルール化',
                            actions: [
                                'DHが個別の理由を添えて提案：「〇〇さんのこの部位は3ヶ月後に再確認が必要」',
                                '受付へ誘導する前に、診療室内でアポイントを確定',
                                '予約の重要性が増し、受付の負担軽減にも繋がる'
                            ]
                        },
                        {
                            category: 'キャンセル枠リカバリー体制',
                            actions: [
                                '予約が取れなかった患者に「空きが出たら連絡を希望するか」を確認しリスト化',
                                'スプレッドシートでキャンセル待ちリストを管理',
                                '空きが出た瞬間にLINE・電話で一斉連絡し、即座に枠を埋める'
                            ]
                        },
                        {
                            category: '今週からすぐできること',
                            actions: [
                                '今日：DHにチェアサイド予約の重要性を説明',
                                '明日：キャンセル待ちリスト用のスプレッドシートを作成',
                                '今週中：DHがチェアサイドで予約を取る練習を実施'
                            ]
                        }
                    ]
                }
            ]
        },

        // ========================================
        // スタッフ定着の提案
        // ========================================
        staffRetention: {
            title: 'スタッフ定着戦略',
            icon: '🤝',
            items: [
                {
                    title: '5分間トーク（1on1）とコミュニケーション強化',
                    description: '「疑問→不安→不満→退職」というプロセスを辿る前に、日々の小さなズレを修正。毎日5分の1on1が定着率を劇的に改善します。',
                    effect: 'チーム力強化でモチベーション +25%、定期研修で退職者削減の実績',
                    difficulty: '低',
                    period: '効果発現まで約1ヶ月',
                    steps: [
                        '終礼時に教育担当と新人が毎日5分間の振り返りを実施',
                        '3ヶ月に一度は院長または幹部が20〜30分の個別面談を実施',
                        'サンキューカードでスタッフ間の感謝を可視化し、承認文化を醸成'
                    ],
                    detailedActions: [
                        {
                            category: '5分間トークの定着',
                            actions: [
                                'その日の「できたこと」を承認し、明日から実践することを明確にする',
                                '業務の進捗だけでなく、気持ちの面での変化も確認',
                                'この習慣で離職率が10倍改善（10〜20%→1〜2%）することが証明されている'
                            ]
                        },
                        {
                            category: 'スタッフカルテの作成',
                            actions: [
                                '家族構成、趣味、好きなもの、価値観などを記録',
                                '誕生日のサプライズやお土産選びに活用',
                                '「自分のことを見てくれている」という安心感を与える'
                            ]
                        },
                        {
                            category: '今週からすぐできること',
                            actions: [
                                '今日：終礼に5分間トークの時間を追加することを宣言',
                                '明日：5分間トーク用の簡単なチェックシートを作成',
                                '今週中：スタッフ全員の「スタッフカルテ」の作成を開始'
                            ]
                        }
                    ]
                },
                {
                    title: '理念浸透と多段階オリエンテーション',
                    description: '単なる「やり方」の伝達ではなく、医院の「あり方」（理念・考え方）を浸透させ、価値観のズレによる早期離職を防ぎます。',
                    effect: '離職率 10〜20%→1〜2%（定着率10倍）の実績',
                    difficulty: '中',
                    period: '効果発現まで約3ヶ月',
                    steps: [
                        '入社後3ヶ月にわたる多段階オリエンテーション（理念→あり方→チームワーク）を実施',
                        '新入社員の家族を招待した入社式で、医院の想いを伝え帰属意識を高める',
                        '定期的な理念研修で「なぜこの仕事をするのか」を共有'
                    ],
                    detailedActions: [
                        {
                            category: '3ヶ月オリエンテーション',
                            actions: [
                                '1ヶ月目：医院の規律、理念、「3つのため」（患者・医院・自分のため）を説明',
                                '2ヶ月目：社会人・医療人としての「あり方」、理想のスタッフ像を伝える',
                                '3ヶ月目：チームワークの大切さ、プロジェクト活動の「意味付け」で主体性を育む'
                            ]
                        },
                        {
                            category: '家族を巻き込んだ入社式',
                            actions: [
                                '新入社員の親や配偶者を招待し、医院の理念や院長の想いを伝える',
                                '事前に家族から預かった「激励の手紙」をサプライズで読む',
                                '家族からの「良い医院に就職したね」という後押しが早期離職を強力に防ぐ'
                            ]
                        },
                        {
                            category: '今週からすぐできること',
                            actions: [
                                '今日：医院理念を改めて文章化（なければ作成）',
                                '明日：3ヶ月オリエンテーションのカリキュラム骨子を作成',
                                '今週中：スタッフ全員に理念を再共有するミーティングを設定'
                            ]
                        }
                    ]
                },
                {
                    title: '評価制度とキャリアパスの明確化',
                    description: '「頑張っても評価されない」「将来が見えない」という不満が離職の大きな要因。透明性の高い評価制度とキャリアパスで長期的なモチベーションを維持します。',
                    effect: 'スタッフ満足度 +30%、3年以上勤続率の大幅改善実績',
                    difficulty: '中',
                    period: '効果発現まで約3-6ヶ月',
                    steps: [
                        '役職・等級ごとに求めるスキルと給与を明文化し、全員に公開',
                        '半年に一度の評価面談で、達成度と次の目標を明確に設定',
                        'チーフ・主任などの中間管理職を設置し、キャリアアップの道筋を示す'
                    ],
                    detailedActions: [
                        {
                            category: '評価制度の構築',
                            actions: [
                                '「態度・姿勢」「技術・スキル」「成果・貢献」の3軸で評価項目を設定',
                                '評価基準を数値化し、主観を排除した公平な評価を実現',
                                '評価結果を昇給・賞与に反映し、頑張りが報われる仕組みを作る'
                            ]
                        },
                        {
                            category: 'キャリアパスの可視化',
                            actions: [
                                '新人→中堅→チーフ→主任→幹部という成長ステップを明示',
                                '各ステップで必要なスキル・研修を一覧化',
                                '「3年後、5年後にこうなれる」という具体的なビジョンを示す'
                            ]
                        },
                        {
                            category: '今週からすぐできること',
                            actions: [
                                '今日：現在の給与テーブルと昇給基準を整理',
                                '明日：スタッフに「どんな評価制度があれば嬉しいか」をヒアリング',
                                '今週中：評価項目の素案を作成'
                            ]
                        }
                    ]
                }
            ]
        },

        // ========================================
        // スタッフ採用の提案
        // ========================================
        staffRecruitment: {
            title: 'スタッフ採用戦略',
            icon: '👥',
            items: [
                {
                    title: 'つながり採用（リファラル）の仕組み化',
                    description: 'DH有効求人倍率は20倍超。ハローワークや求人サイトで「待つ」だけでは質の高い人財の獲得は困難。つながり採用が最も定着率が高いです。',
                    effect: '応募数 +50%、採用単価 -30%、定着率が一般採用の2倍',
                    difficulty: '中',
                    period: '効果発現まで約2-3ヶ月',
                    steps: [
                        '既存スタッフへの紹介報酬を明示（入社時10万円、試用期間後10万円等）',
                        '紹介してくれたスタッフとの食事代を医院が負担',
                        '出身大学の医局、専門学校の後輩へ定期的に連絡・食事会で関係維持'
                    ],
                    detailedActions: [
                        {
                            category: 'つながり採用の仕組み化',
                            actions: [
                                '紹介による採用時の報酬制度を明文化し、スタッフに周知',
                                '「知り合いに良い人がいたら教えて」と定期的に声かけ',
                                '紹介者と被紹介者が同じシフトになるよう配慮し、居心地を確保'
                            ]
                        },
                        {
                            category: 'OB・OG活用',
                            actions: [
                                '円満退職したスタッフとの関係を維持（年賀状、食事会）',
                                '元スタッフからの紹介も報酬対象に',
                                '出戻り歓迎の姿勢を明示し、復職のハードルを下げる'
                            ]
                        },
                        {
                            category: '今週からすぐできること',
                            actions: [
                                '今日：紹介採用の報酬制度案を作成',
                                '明日：スタッフ全員に「紹介したい人がいるか」をヒアリング',
                                '今週中：元スタッフに近況確認のLINEを送る'
                            ]
                        }
                    ]
                },
                {
                    title: '学校連携と実習生の「おもてなし」採用',
                    description: '衛生士学校との関係構築が採用の要。実習生を「掃除係」扱いせず、感動体験を提供することで「ここで働きたい」を引き出します。',
                    effect: '採用フェスでブース訪問71名・19名見学の実績',
                    difficulty: '中',
                    period: '効果発現まで約6ヶ月',
                    steps: [
                        '毎年決まった時期に衛生士学校の就職担当を訪問し関係構築',
                        '実習生にウェルカムボードで歓迎の意を示す',
                        '最終日に色紙・花束でサプライズのお別れ会を実施'
                    ],
                    detailedActions: [
                        {
                            category: '学校訪問の定例化',
                            actions: [
                                '年2回（春・秋）の定期訪問をスケジュール化',
                                '就職担当教員との関係を深め、優秀な学生を紹介してもらう',
                                '学校の授業や講演に院長・スタッフが講師として参加'
                            ]
                        },
                        {
                            category: '実習生への「おもてなし」',
                            actions: [
                                '年の近い先輩が教育担当として寄り添い、一緒にランチを取る',
                                '最終日には色紙や花束でサプライズのお別れ会',
                                '2〜3ヶ月後に食事→アルバイト勧誘→就職というステップを設計'
                            ]
                        },
                        {
                            category: '今週からすぐできること',
                            actions: [
                                '今日：近隣の衛生士学校リストを作成',
                                '明日：次回実習生受入れ時のウェルカムボードを準備',
                                '今週中：学校訪問のアポイントを取る'
                            ]
                        }
                    ]
                },
                {
                    title: '理念共感型採用と採用ブランディング',
                    description: '採用が経営の9割を決めます。「誰でもいいから来てほしい」ではなく、医院の理念に共感する人財だけを採用することで定着率が劇的に向上します。',
                    effect: '入社後1年以内離職率 50%→5%への改善実績',
                    difficulty: '中',
                    period: '効果発現まで約3ヶ月',
                    steps: [
                        '面接時に医院理念・行動指針（クレド）をスライドで見せ、共感できるかを確認',
                        '採用ページに院長の想い、スタッフインタビューを充実させる',
                        'SNSで医院の日常・雰囲気を発信し、「ここで働きたい」と思わせる'
                    ],
                    detailedActions: [
                        {
                            category: '理念共感の確認',
                            actions: [
                                '「なぜ歯科医療の仕事を選んだのか」を深掘りして価値観を確認',
                                '医院理念を説明し、共感度合いを5段階で自己評価してもらう',
                                '「お金のため」「近いから」だけの動機の人は採用しない勇気を持つ'
                            ]
                        },
                        {
                            category: '採用ブランディング',
                            actions: [
                                'Instagram・TikTokで医院の雰囲気、スタッフの笑顔を発信',
                                '「うちの医院で働くとこうなれる」というキャリアストーリーを紹介',
                                '採用ページは「応募してもらう」ではなく「共感してもらう」設計に'
                            ]
                        },
                        {
                            category: '今週からすぐできること',
                            actions: [
                                '今日：面接時に理念共感を確認する質問リストを作成',
                                '明日：医院のInstagramアカウントを開設（または更新計画を立てる）',
                                '今週中：採用ページの内容を見直し、理念を追加'
                            ]
                        }
                    ]
                }
            ]
        },

        // ========================================
        // 業務効率化の提案
        // ========================================
        efficiency: {
            title: '業務効率化戦略',
            icon: '⚡',
            items: [
                {
                    title: 'タスクシフトとクリーンスタッフの戦略的活用',
                    description: '歯科医院の最大のボトルネックはDr。Drでなければできない業務以外を他職種へ徹底的に移管し、生産性を向上させます。',
                    effect: 'クリーンスタッフ採用で片付け時間削減、残業時間ダウン、正社員が定時帰宅可能の実績',
                    difficulty: '中',
                    period: '効果発現まで約1ヶ月',
                    steps: [
                        'ユニットの後片付け・滅菌・準備を専任パート（クリーンスタッフ）に任せる',
                        'DHが浸潤麻酔セミナーを受講し、認定DHが浸潤麻酔を実施→Dr待ち時間ゼロに',
                        'HP更新・SNS運用を専任のWEB専門スタッフに任せる'
                    ],
                    detailedActions: [
                        {
                            category: 'クリーンスタッフ（CS）の導入',
                            actions: [
                                '片付け、滅菌、準備、写真整理、カルテスキャンを専任パートに任せる',
                                'DHや助手が診療に専念できる環境を作る',
                                '週2〜3日、1日4時間程度のパート採用で十分効果あり'
                            ]
                        },
                        {
                            category: 'DHへのタスクシフト',
                            actions: [
                                '浸潤麻酔セミナー受講で認定DHが浸潤麻酔を実施',
                                'Drが麻酔を待つ時間をゼロにし、チェアタイムを有効活用',
                                'SRPや処置の効率が飛躍的に向上'
                            ]
                        },
                        {
                            category: '今週からすぐできること',
                            actions: [
                                '今日：現在の「Drでなくてもできる業務」をリストアップ',
                                '明日：クリーンスタッフの求人条件（時給、時間帯）を検討',
                                '今週中：近隣の浸潤麻酔セミナーをDHに案内'
                            ]
                        }
                    ]
                },
                {
                    title: '受付業務のデジタル化（受付ゼロ化計画）',
                    description: '受付はミスが発生しやすく、心理的負担も大きい部署。デジタル化で人件費を抑えながら24時間対応可能なサービスを提供します。',
                    effect: '受付業務 -30%の効率化、会計待ち時間20分→数分に短縮',
                    difficulty: '中',
                    period: '効果発現まで約1-2ヶ月',
                    steps: [
                        '電話での予約・変更対応をWEB予約・LINE予約に移行',
                        '自動精算機・キャッシュレス決済を導入し、会計業務を軽減',
                        '診察券アプリに移行し、紙の発行・紛失対応をゼロに'
                    ],
                    detailedActions: [
                        {
                            category: '自動精算機とキャッシュレス決済',
                            actions: [
                                'ユニットサイドで会計金額を確定→患者が直接機械で支払うフロー',
                                '「ささっとPay」などの後払いシステムで診療後すぐ帰宅可能に',
                                '受付スタッフが予約取りや電話応対に集中できる環境を作る'
                            ]
                        },
                        {
                            category: 'ペーパーレス化',
                            actions: [
                                '診察券アプリで紙の診察券の発行・紛失対応をゼロに',
                                '同意書・個人情報取り扱い同意書をデジタル署名で管理',
                                'WEB問診で来院前に入力してもらい、受付滞在時間を短縮'
                            ]
                        },
                        {
                            category: '今週からすぐできること',
                            actions: [
                                '今日：現在の受付業務の時間配分を計測（何に何分かかっているか）',
                                '明日：自動精算機・診察券アプリの資料請求',
                                '今週中：WEB問診のURLをネット予約完了メールに追加'
                            ]
                        }
                    ]
                },
                {
                    title: '動画マニュアルとAIツールの活用',
                    description: '「何度も同じことを教える」時間を削減し、教育の質を均一化。AI活用で記録業務の時間を大幅に短縮します。',
                    effect: '診療時間内にブログ作成、月12〜15本投稿の実績、カルテ1時間以上の削減',
                    difficulty: '中',
                    period: '効果発現まで約2ヶ月',
                    steps: [
                        '器具の準備・片付け・術式・接遇などをスマホで撮影し動画マニュアル化',
                        'AI音声入力・要約ツール（PLAUD NOTE等）でカウンセリング内容を自動記録',
                        'ChatGPTで口コミ返信・ブログ構成案・トークスクリプトを効率作成'
                    ],
                    detailedActions: [
                        {
                            category: '動画マニュアルの作成',
                            actions: [
                                'iPhoneで撮影し、YouTubeの限定公開や専用システム（JISSEN等）で共有',
                                '新人は自宅や隙間時間に予習・復習が可能',
                                '指導者の拘束時間を最小限に抑え、技術の標準化も実現'
                            ]
                        },
                        {
                            category: 'AIツールの活用',
                            actions: [
                                'AI音声入力ツール：カウンセリング内容やDr指示を自動記録→AIが要約・部位リスト化',
                                'AIセファロ分析（WEBCEPH）：矯正診断の効率化',
                                'ChatGPT：口コミ返信、ブログ構成案、トークスクリプト作成を効率化'
                            ]
                        },
                        {
                            category: '今週からすぐできること',
                            actions: [
                                '今日：最も質問が多い業務を1つ選び、スマホで動画撮影',
                                '明日：ChatGPTで口コミ返信文を作成してみる',
                                '今週中：動画マニュアル用のYouTubeチャンネル（限定公開）を作成'
                            ]
                        }
                    ]
                }
            ]
        }
    },

    // ========================================
    // 分岐条件別の追加アドバイス（出力精度向上用）
    // ========================================
    BRANCHING_CONDITIONS: {
        // 地域×課題の組み合わせ別アドバイス
        regional: {
            // 都市部（競合多い）
            urban: {
                regions: ['kanto', 'kinki'],
                newPatient: {
                    emphasis: '差別化',
                    additionalAdvice: '競合が多い地域では、MEOでの上位表示に加え「専門性」のアピールが重要です。矯正専門、小児専門など、強みを明確に打ち出しましょう。',
                    specificActions: [
                        'ホームページのファーストビューに専門性を明記',
                        'Googleビジネスプロフィールのサービス説明に専門キーワードを追加',
                        '症例写真を週2回以上アップロードして専門性をアピール'
                    ]
                },
                selfPay: {
                    emphasis: '価値訴求',
                    additionalAdvice: '都市部の患者は情報収集能力が高いため、治療の価値を論理的に説明することが効果的です。',
                    specificActions: [
                        '治療別の比較資料（費用対効果、耐久年数）を作成',
                        '症例写真付きのビフォーアフター集を整備',
                        'デンタルローンの月々払い金額を明示'
                    ]
                }
            },
            // 地方部（競合少ない）
            rural: {
                regions: ['hokkaido', 'tohoku', 'chugoku', 'shikoku'],
                newPatient: {
                    emphasis: '地域密着',
                    additionalAdvice: '地方では「かかりつけ医」としての信頼構築が最重要。地域コミュニティとの関係強化を優先しましょう。',
                    specificActions: [
                        '地域の学校健診や企業健診への積極参加',
                        '地元の祭りやイベントへの協賛・参加',
                        '院長やスタッフの地域活動をSNSで発信'
                    ]
                },
                selfPay: {
                    emphasis: '信頼関係',
                    additionalAdvice: '地方では「この先生が言うなら間違いない」という信頼が自費決定の鍵。長期的な関係構築を重視しましょう。',
                    specificActions: [
                        'メンテナンス時に丁寧な説明を重ねて信頼を蓄積',
                        '家族単位での来院を促進し、世帯全体の信頼を獲得',
                        '地域の方言や文化を尊重したコミュニケーション'
                    ]
                }
            }
        },

        // 開業年数別アドバイス
        yearsOpen: {
            // 開業3年未満
            'under3': {
                phase: '成長期',
                priority: '認知拡大',
                generalAdvice: '開業3年未満は「知ってもらう」ことが最優先。広告費は惜しまず、まずは新患数を確保しましょう。',
                recommendations: {
                    newPatient: {
                        additionalAdvice: '開業初期はMEO対策に加え、リスティング広告やSNS広告も併用して認知を急拡大させましょう。',
                        specificActions: [
                            '月間広告予算を売上の5-10%に設定',
                            'Instagram・TikTokで院内の雰囲気を発信',
                            '開院記念キャンペーン（ホワイトニング割引等）を実施'
                        ]
                    },
                    efficiency: {
                        additionalAdvice: '開業初期は売上拡大が優先。効率化より「患者を断らない体制」を構築しましょう。',
                        specificActions: [
                            '新患・急患枠を多めに確保',
                            '柔軟な診療時間の設定',
                            'パート採用で繁忙期に対応'
                        ]
                    }
                }
            },
            // 開業3-5年
            '3to5': {
                phase: '確立期',
                priority: '収益基盤強化',
                generalAdvice: '開業3-5年は「稼ぐ力」を身につける時期。自費率向上とリピート率強化に注力しましょう。',
                recommendations: {
                    selfPay: {
                        additionalAdvice: '基盤患者ができてきた時期。既存患者への自費提案を強化し、客単価を上げましょう。',
                        specificActions: [
                            'メンテナンス患者への審美提案を仕組み化',
                            'カウンセリングルームの整備',
                            '補綴説明用の模型・資料を充実'
                        ]
                    },
                    staffRetention: {
                        additionalAdvice: '成長期のスタッフ育成が今後の医院を決めます。幹部候補の育成を始めましょう。',
                        specificActions: [
                            '将来の幹部候補を選定し、マネジメント研修に参加',
                            '業務の標準化（マニュアル作成）を開始',
                            'スタッフ評価制度の導入'
                        ]
                    },
                    staffRecruitment: {
                        additionalAdvice: '採用力を高める時期。つながり採用の仕組みを作りましょう。',
                        specificActions: [
                            '紹介採用の報酬制度を明文化',
                            '衛生士学校との関係構築を開始',
                            '採用ページの充実'
                        ]
                    }
                }
            },
            // 開業5-10年
            '5to10': {
                phase: '成熟期',
                priority: 'システム化',
                generalAdvice: '開業5-10年は「院長がいなくても回る仕組み」を作る時期。属人化を排除しましょう。',
                recommendations: {
                    efficiency: {
                        additionalAdvice: 'この時期に仕組み化を怠ると、院長の時間がボトルネックになります。タスクシフトを断行しましょう。',
                        specificActions: [
                            '院長しかできない業務を棚卸し',
                            'DHへの権限委譲（浸潤麻酔等）',
                            '幹部に経営数値を共有し、経営参画意識を醸成'
                        ]
                    },
                    cancel: {
                        additionalAdvice: '患者数が安定してきたら、質の向上にシフト。キャンセル率の改善で収益性を高めましょう。',
                        specificActions: [
                            'キャンセルポリシーの明文化と運用開始',
                            'リマインド自動化システムの導入',
                            'キャンセル常習者への対応ルール策定'
                        ]
                    }
                }
            },
            // 開業10-20年
            '10to20': {
                phase: '最適化期',
                priority: '世代交代準備',
                generalAdvice: '開業10-20年は次の10年を見据えた体制構築の時期。設備更新と人材の若返りを計画的に進めましょう。',
                recommendations: {
                    staffRetention: {
                        additionalAdvice: '長年のスタッフが退職すると大きな穴が開きます。評価制度とキャリアパスで定着を図りましょう。',
                        specificActions: [
                            'ベテランスタッフの暗黙知を動画マニュアル化',
                            '若手への段階的な権限委譲',
                            '長期勤続者への感謝制度の導入'
                        ]
                    },
                    staffRecruitment: {
                        additionalAdvice: '計画的な採用で、スムーズな世代交代を準備しましょう。',
                        specificActions: [
                            '3年後の組織図を描き、必要な人材を逆算採用',
                            '若手DH・助手の積極採用',
                            '学校連携を強化し、実習生からの採用ルートを確保'
                        ]
                    },
                    efficiency: {
                        additionalAdvice: '古い設備やシステムが足かせになっていませんか？大規模な設備更新を検討する時期です。',
                        specificActions: [
                            'ユニット・レントゲンの更新計画を策定',
                            '電子カルテ・予約システムの見直し',
                            '院内LAN・WiFi環境の整備'
                        ]
                    }
                }
            },
            // 開業20年以上
            'over20': {
                phase: '継承期',
                priority: '事業承継',
                generalAdvice: '開業20年以上は事業承継を意識する時期。第三者承継も含めた選択肢を検討しましょう。',
                recommendations: {
                    newPatient: {
                        additionalAdvice: '長年の信頼がある一方、若い患者層の取り込みが課題に。SNS活用など新しい集患方法を取り入れましょう。',
                        specificActions: [
                            '若手スタッフ主導でSNS運用を開始',
                            'ホームページのデザインリニューアル',
                            '若年層向けメニュー（ホワイトニング、矯正）の強化'
                        ]
                    },
                    efficiency: {
                        additionalAdvice: '長年の「当たり前」を見直す良い機会です。外部コンサルタントの客観的な視点を活用しましょう。',
                        specificActions: [
                            '業務フローの棚卸しと無駄の洗い出し',
                            'デジタル化への投資（DX）',
                            '事業承継コンサルタントへの相談'
                        ]
                    }
                }
            }
        },

        // 売上規模別アドバイス
        revenue: {
            // 月商300万円未満
            small: {
                threshold: 300,
                compare: 'less',
                generalAdvice: '月商300万円未満の場合、まずは新患数の増加が最優先。経費削減より売上拡大に注力しましょう。',
                recommendations: {
                    newPatient: {
                        emphasis: '集患最優先',
                        additionalAdvice: '広告費・MEO対策への投資を惜しまず、まずは来院数を確保することが先決です。',
                        specificActions: [
                            'MEO対策を最優先で実施',
                            '月間広告予算を売上の10%以上に設定',
                            '急患・新患を断らない体制構築'
                        ]
                    }
                }
            },
            // 月商500万円以上
            medium: {
                threshold: 500,
                compare: 'greaterOrEqual',
                generalAdvice: '月商500万円を超えたら、自費率向上による客単価アップが次のステージへの鍵です。',
                recommendations: {
                    selfPay: {
                        emphasis: '客単価向上',
                        additionalAdvice: '新患数は安定しています。既存患者への自費提案を強化し、LTV（顧客生涯価値）を高めましょう。',
                        specificActions: [
                            'メンテナンス時の自費提案ルーティン化',
                            'カウンセリングスキル研修の実施',
                            '補綴メニューの見直しと単価アップ'
                        ]
                    }
                }
            },
            // 月商1000万円以上
            large: {
                threshold: 1000,
                compare: 'greaterOrEqual',
                generalAdvice: '月商1000万円を超える医院は、効率化と人材育成が成長の鍵。院長の時間を経営に振り向けましょう。',
                recommendations: {
                    efficiency: {
                        emphasis: '経営最適化',
                        additionalAdvice: '売上が安定した今こそ、仕組み化と効率化で利益率を高める時期です。',
                        specificActions: [
                            '勤務医の採用を検討',
                            'タスクシフトの徹底',
                            '経営数値のKPI管理を導入'
                        ]
                    },
                    staffRetention: {
                        emphasis: '組織強化',
                        additionalAdvice: 'スタッフ数が増える段階では、マネジメント体制の構築が必須です。',
                        specificActions: [
                            'チーフ・主任など中間管理職の設置',
                            '評価制度と給与体系の整備',
                            '幹部合宿や経営会議の定例化'
                        ]
                    },
                    staffRecruitment: {
                        emphasis: '人材確保',
                        additionalAdvice: '成長に合わせた人材確保が必要。計画的な採用で組織力を高めましょう。',
                        specificActions: [
                            '勤務医・DHの積極採用',
                            '採用専任担当者の設置',
                            '複数の採用チャネルの活用'
                        ]
                    }
                }
            }
        },

        // ユニット数別アドバイス
        units: {
            // 3台以下
            small: {
                threshold: 3,
                compare: 'lessOrEqual',
                generalAdvice: 'ユニット3台以下はアットホームさが強み。少数精鋭で患者満足度を高めましょう。',
                recommendations: {
                    efficiency: {
                        additionalAdvice: 'ユニット数が少ない分、回転率を上げることが重要。アポイント管理を徹底しましょう。',
                        specificActions: [
                            '1アポあたりの処置内容を最適化',
                            '準備・片付け時間の短縮',
                            '予約枠の細分化（15分単位）'
                        ]
                    }
                }
            },
            // 6台以上
            large: {
                threshold: 6,
                compare: 'greaterOrEqual',
                generalAdvice: 'ユニット6台以上は組織としての運営が必要。システムと役割分担を明確にしましょう。',
                recommendations: {
                    staffRetention: {
                        additionalAdvice: 'スタッフ数が多くなると、情報共有とチームワークが課題に。定期ミーティングを仕組み化しましょう。',
                        specificActions: [
                            '朝礼・終礼の内容を標準化',
                            '週1回のケースカンファレンス',
                            'スタッフ間の役割分担表作成'
                        ]
                    },
                    staffRecruitment: {
                        additionalAdvice: '複数ユニットを稼働させるには十分な人材確保が必要です。',
                        specificActions: [
                            'ユニット数に応じた必要人員を明確化',
                            '常に1〜2名の採用バッファを持つ',
                            '急な欠員に備えた人材プールの構築'
                        ]
                    },
                    efficiency: {
                        additionalAdvice: '複数ユニットを効率的に稼働させるため、ゾーニングとフロー設計が重要です。',
                        specificActions: [
                            'Dr動線とDH動線を分離',
                            'ユニットごとの担当制（ゾーニング）',
                            '器具・材料のユニット配置最適化'
                        ]
                    }
                }
            }
        }
    },

    // ========================================
    // パーセンタイル計算用データ
    // ========================================
    PERCENTILE_DATA: {
        newPatient: [5, 8, 10, 12, 15, 18, 20, 22, 25, 28, 30, 33, 35, 38, 40, 45, 50, 60, 70, 85],
        selfPayRate: [3, 5, 6, 7, 8, 9, 10, 11, 12, 14, 16, 18, 20, 23, 26, 30, 35, 40, 48, 55],
        recall: [15, 20, 25, 28, 32, 35, 38, 42, 45, 48, 52, 55, 58, 62, 66, 70, 75, 80, 85, 92]
    },

    // ========================================
    // Gemini API設定
    // ========================================
    GEMINI_CONFIG: {
        model: 'gemini-1.5-flash',
        maxOutputTokens: 2048,
        temperature: 0.7
    },

    // ========================================
    // ヘルパー関数
    // ========================================

    calculatePercentile(value, dataArray) {
        const sorted = [...dataArray].sort((a, b) => a - b);
        const n = sorted.length;

        if (value <= sorted[0]) {
            const ratio = Math.max(0, value / sorted[0]);
            return Math.round(ratio * (100 / n) * 10) / 10;
        }

        if (value >= sorted[n - 1]) {
            const excess = (value - sorted[n - 1]) / sorted[n - 1];
            const percentile = 95 + Math.min(4.9, excess * 10);
            return Math.round(percentile * 10) / 10;
        }

        for (let i = 0; i < n - 1; i++) {
            if (value >= sorted[i] && value < sorted[i + 1]) {
                const lowerPercentile = ((i + 1) / n) * 100;
                const upperPercentile = ((i + 2) / n) * 100;
                const ratio = (value - sorted[i]) / (sorted[i + 1] - sorted[i]);
                const percentile = lowerPercentile + ratio * (upperPercentile - lowerPercentile);
                return Math.round(percentile * 10) / 10;
            }
        }

        return Math.round((n / n) * 100 * 10) / 10;
    },

    getRecommendations(priority, formData) {
        const recommendations = this.RECOMMENDATIONS[priority];
        if (!recommendations) return null;

        // 分岐条件を取得
        const branchingAdvice = this.getBranchingAdvice(priority, formData);

        const customizedItems = recommendations.items.map((item, index) => {
            const customItem = { ...item };

            // 地域に基づく追加アドバイス
            if (formData.region && this.REGIONAL_DATA[formData.region]) {
                const regional = this.REGIONAL_DATA[formData.region];
                if (regional.competition === 'high' && priority === 'newPatient') {
                    customItem.additionalNote = '競合の多い地域のため、差別化戦略が特に重要です。';
                }
            }

            // 開業年数に基づく追加アドバイス
            if (formData.yearsOpen && this.YEARS_DATA[formData.yearsOpen]) {
                const yearsData = this.YEARS_DATA[formData.yearsOpen];
                if (yearsData.phase === 'growth') {
                    customItem.priorityNote = '成長期の医院には特に効果的な施策です。';
                }
            }

            // 分岐条件からの追加アクションを最初の提案に追加
            if (index === 0 && branchingAdvice.specificActions && branchingAdvice.specificActions.length > 0) {
                if (!customItem.detailedActions) {
                    customItem.detailedActions = [];
                }
                customItem.detailedActions.push({
                    category: '貴院の状況に合わせた追加アドバイス',
                    actions: branchingAdvice.specificActions
                });
            }

            return customItem;
        });

        return {
            ...recommendations,
            items: customizedItems,
            situationalAdvice: branchingAdvice.situationalAdvice || null,
            phaseAdvice: branchingAdvice.phaseAdvice || null
        };
    },

    // 分岐条件に基づく追加アドバイスを取得
    getBranchingAdvice(priority, formData) {
        const result = {
            specificActions: [],
            situationalAdvice: null,
            phaseAdvice: null
        };

        const branching = this.BRANCHING_CONDITIONS;

        // 1. 地域別アドバイス
        if (formData.region) {
            // 都市部チェック
            if (branching.regional.urban.regions.includes(formData.region)) {
                const urbanAdvice = branching.regional.urban[priority];
                if (urbanAdvice) {
                    result.situationalAdvice = urbanAdvice.additionalAdvice;
                    result.specificActions.push(...(urbanAdvice.specificActions || []));
                }
            }
            // 地方部チェック
            else if (branching.regional.rural.regions.includes(formData.region)) {
                const ruralAdvice = branching.regional.rural[priority];
                if (ruralAdvice) {
                    result.situationalAdvice = ruralAdvice.additionalAdvice;
                    result.specificActions.push(...(ruralAdvice.specificActions || []));
                }
            }
        }

        // 2. 開業年数別アドバイス
        if (formData.yearsOpen && branching.yearsOpen[formData.yearsOpen]) {
            const yearsAdvice = branching.yearsOpen[formData.yearsOpen];
            result.phaseAdvice = yearsAdvice.generalAdvice;

            if (yearsAdvice.recommendations && yearsAdvice.recommendations[priority]) {
                const priorityAdvice = yearsAdvice.recommendations[priority];
                if (priorityAdvice.specificActions) {
                    result.specificActions.push(...priorityAdvice.specificActions);
                }
                if (!result.situationalAdvice && priorityAdvice.additionalAdvice) {
                    result.situationalAdvice = priorityAdvice.additionalAdvice;
                }
            }
        }

        // 3. 売上規模別アドバイス
        if (formData.totalRevenue) {
            const revenue = parseFloat(formData.totalRevenue);
            // 大規模（1000万以上）を優先
            if (revenue >= branching.revenue.large.threshold) {
                const largeAdvice = branching.revenue.large;
                if (largeAdvice.recommendations && largeAdvice.recommendations[priority]) {
                    result.specificActions.push(...(largeAdvice.recommendations[priority].specificActions || []));
                }
            }
            // 中規模（500万以上）
            else if (revenue >= branching.revenue.medium.threshold) {
                const mediumAdvice = branching.revenue.medium;
                if (mediumAdvice.recommendations && mediumAdvice.recommendations[priority]) {
                    result.specificActions.push(...(mediumAdvice.recommendations[priority].specificActions || []));
                }
            }
            // 小規模（300万未満）
            else if (revenue < branching.revenue.small.threshold) {
                const smallAdvice = branching.revenue.small;
                if (smallAdvice.recommendations && smallAdvice.recommendations[priority]) {
                    result.specificActions.push(...(smallAdvice.recommendations[priority].specificActions || []));
                }
            }
        }

        // 4. ユニット数別アドバイス
        if (formData.units) {
            const units = parseInt(formData.units);
            if (units >= branching.units.large.threshold) {
                const largeAdvice = branching.units.large;
                if (largeAdvice.recommendations && largeAdvice.recommendations[priority]) {
                    result.specificActions.push(...(largeAdvice.recommendations[priority].specificActions || []));
                }
            } else if (units <= branching.units.small.threshold) {
                const smallAdvice = branching.units.small;
                if (smallAdvice.recommendations && smallAdvice.recommendations[priority]) {
                    result.specificActions.push(...(smallAdvice.recommendations[priority].specificActions || []));
                }
            }
        }

        // 重複を除去し、最大5件に制限
        result.specificActions = [...new Set(result.specificActions)].slice(0, 5);

        return result;
    },

    generateComparison(formData) {
        const comparison = {
            newPatientPower: { percentile: 50, status: 'average' },
            selfPayPower: { percentile: 50, status: 'average' },
            patientRetention: { percentile: 50, status: 'average' }
        };

        if (formData.newPatient) {
            comparison.newPatientPower.percentile = this.calculatePercentile(
                formData.newPatient,
                this.PERCENTILE_DATA.newPatient
            );
            comparison.newPatientPower.status = this.getStatus(comparison.newPatientPower.percentile);
        }

        if (formData.selfPayRate) {
            comparison.selfPayPower.percentile = this.calculatePercentile(
                formData.selfPayRate,
                this.PERCENTILE_DATA.selfPayRate
            );
            comparison.selfPayPower.status = this.getStatus(comparison.selfPayPower.percentile);
        }

        if (formData.recall) {
            comparison.patientRetention.percentile = this.calculatePercentile(
                formData.recall,
                this.PERCENTILE_DATA.recall
            );
            comparison.patientRetention.status = this.getStatus(comparison.patientRetention.percentile);
        }

        return comparison;
    },

    getStatus(percentile) {
        if (percentile >= 70) return 'excellent';
        if (percentile >= 50) return 'good';
        if (percentile >= 30) return 'average';
        return 'needsImprovement';
    },

    estimateSimilarClinics(formData) {
        let baseCount = 3247;
        let filterFactor = 1;

        if (formData.region) filterFactor *= 0.11;
        if (formData.yearsOpen) filterFactor *= 0.2;
        if (formData.units) filterFactor *= 0.125;
        if (formData.insurance || formData.selfPay) filterFactor *= 0.15;

        return Math.max(10, Math.floor(baseCount * filterFactor));
    },

    generateGeminiPrompt(formData, priority) {
        const priorityLabels = {
            newPatient: '新患獲得',
            selfPay: '自費率向上',
            cancel: 'キャンセル削減',
            staff: 'スタッフ定着・採用',
            efficiency: '業務効率化'
        };

        return `あなたは歯科医院経営の専門コンサルタントです。以下の歯科医院のデータを分析し、${priorityLabels[priority] || '経営改善'}に関する具体的なアドバイスを提供してください。

## 医院データ
- 地域: ${formData.region || '未入力'}
- 開業年数: ${formData.yearsOpen || '未入力'}
- ユニット数: ${formData.units || '未入力'}台
- 月間新患数: ${formData.newPatient || '未入力'}人
- 1日平均来院数: ${formData.dailyVisit || '未入力'}人
- 月間保険収入: ${formData.insurance || '未入力'}万円
- 月間自費収入: ${formData.selfPay || '未入力'}万円
- キャンセル率: ${formData.cancel || '未入力'}%
- リコール率: ${formData.recall || '未入力'}%
- レセプト枚数: ${formData.receipt || '未入力'}枚/月
- その他の悩み: ${formData.otherConcerns || 'なし'}

## 回答形式
以下の形式で回答してください：

1. **現状分析**（100字程度）
   - データから読み取れる強みと課題

2. **優先すべき改善施策**（3つ）
   各施策について：
   - タイトル
   - 具体的な実行ステップ（3-5ステップ）
   - 期待される効果
   - 実行の難易度（低/中/高）

3. **短期的に着手すべきこと**（今週からできること）

回答は具体的で実行可能な内容にしてください。`;
    }
};

// グローバルに公開
window.KnowledgeBase = KnowledgeBase;
