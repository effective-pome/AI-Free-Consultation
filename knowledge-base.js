/**
 * 歯科医院AI診断 - ナレッジベース
 *
 * このファイルには、3,247件以上の成功事例データを基にした
 * 診断ロジックと改善提案のデータベースが格納されています。
 *
 * 【ナレッジベースの設定方法】
 *
 * 1. 業界平均値の設定:
 *    - INDUSTRY_BENCHMARKS: 各指標の業界平均値を設定
 *    - これらの値は実際のデータ分析結果に基づいて更新してください
 *
 * 2. 課題別の改善提案:
 *    - RECOMMENDATIONS: 各課題に対する具体的な提案を設定
 *    - 各提案には、タイトル、説明、実行ステップ、期待効果を含めます
 *
 * 3. AIヒント条件:
 *    - AI_HINTS: 入力値に基づいて表示するヒントを設定
 *    - condition: 表示条件を関数で定義
 *    - message: 表示するメッセージ
 *
 * 4. Gemini API連携:
 *    - useGeminiAPI: trueに設定するとAPI連携が有効化
 *    - generateGeminiPrompt: APIに送信するプロンプトをカスタマイズ
 */

const KnowledgeBase = {
    // ========================================
    // 医業収入規模別の優先施策
    // ========================================
    REVENUE_SCALE_PRIORITIES: {
        // 年間5,000万〜1億円：新患獲得と基盤固め
        'scale_small': {
            range: { min: 400, max: 850 },  // 月商（万円）
            label: '成長期（年商5,000万〜1億円）',
            description: 'まずは新患獲得に注力し、安定した患者基盤を構築する段階です。',
            priorities: ['newPatient', 'efficiency'],
            keyActions: [
                'HP強化：ブログ週1回、E-E-A-T対応、スマホ最適化',
                'Googleビジネスプロフィール充実：口コミ100件・評価4.5以上を目標',
                '院前ポスト・看板による認知拡大',
                'WEB予約システム導入',
                '基本的な労務環境の整備'
            ]
        },
        // 年間1億〜3億円：自費率UP・スタッフ採用・仕組み化
        'scale_medium': {
            range: { min: 850, max: 2500 },
            label: '拡大期（年商1億〜3億円）',
            description: '自費診療の拡大とスタッフ体制の強化を並行して進める段階です。',
            priorities: ['selfPay', 'staffRecruitment', 'cancel'],
            keyActions: [
                'カウンセリングフローの仕組み化：三段階カウンセリング導入',
                '小児矯正・MFTの導入',
                'TC育成：院長の負担軽減と成約率向上',
                'つながり採用・学校連携の強化',
                'PPC広告・LP運用：自費診療の新患獲得強化',
                '人事評価制度の導入'
            ]
        },
        // 年間3億円以上：組織力強化・多職種連携・文化構築
        'scale_large': {
            range: { min: 2500, max: 99999 },
            label: '成熟期（年商3億円以上）',
            description: '組織として自走できる体制を構築し、院長の経営・マネジメントへの専念を実現する段階です。',
            priorities: ['staffRetention', 'efficiency'],
            keyActions: [
                '幹部会運用による情報共有強化',
                'プロジェクトチーム制度の導入',
                '多職種採用：WEB専門・クリーンスタッフ',
                'AI・DXツールの本格活用',
                '診療時間短縮（時短診療）',
                '理念共有会（キックオフミーティング）の定期開催'
            ]
        }
    },

    // ========================================
    // 数値別の分岐しきい値
    // ========================================
    METRIC_THRESHOLDS: {
        newPatient: {
            critical: 15,    // 要改善
            low: 25,         // 改善余地あり
            average: 40,     // 平均
            good: 60,        // 良好
            excellent: 80    // 優秀
        },
        selfPayRate: {
            critical: 5,
            low: 10,
            average: 15,
            good: 25,
            excellent: 35
        },
        cancel: {  // 低いほど良い
            excellent: 3,
            good: 5,
            average: 7,
            low: 10,
            critical: 15
        },
        recall: {
            critical: 30,
            low: 40,
            average: 50,
            good: 65,
            excellent: 80
        }
    },

    // ========================================
    // 実績事例データベース
    // ========================================
    SUCCESS_CASES: {
        newPatient: [
            { action: 'MEO対策強化', result: '口コミ56件→116件、新患25人→56人/月に増加', period: '3ヶ月' },
            { action: 'SEO・ブログ強化', result: 'SEO順位11位→4位、月間38,000PV達成', period: '6ヶ月' },
            { action: '矯正LP作成+PPC', result: '導入1ヶ月で矯正契約4件達成', period: '1ヶ月' },
            { action: 'PPC広告活用', result: '開業16年目で新患100名オーバー達成', period: '継続' },
            { action: 'WEB予約導入', result: '導入初月で30件獲得、LINE登録でリスト化', period: '1ヶ月' },
            { action: '院前ポスト設置', result: '2ヶ月で88枚配布、新患100人突破', period: '2ヶ月' },
            { action: '症例発信（Instagram）', result: '月3〜5名来院、ほぼ100%自費治療', period: '継続' }
        ],
        selfPay: [
            { action: 'iTeroカウンセリング', result: 'インビザライン月1件→月5件に増加', period: '2ヶ月' },
            { action: 'MFT導入', result: '月6万→月280万体制を構築', period: '1年' },
            { action: '小児矯正強化', result: '成約率85%を達成', period: '6ヶ月' },
            { action: 'プロジェクトチーム制', result: 'インプラント月1→6症例、自費400万→1,000万', period: '6ヶ月' },
            { action: 'デンタルローン導入', result: '高額治療の成約率+40%', period: '即効' }
        ],
        cancel: [
            { action: 'リマインド自動化', result: 'キャンセル率-40%', period: '即効' },
            { action: 'チェアサイド予約', result: '無断キャンセル-50%', period: '2週間' },
            { action: 'キャンセル待ちリスト', result: '稼働率+15%向上', period: '1ヶ月' }
        ],
        staffRetention: [
            { action: '5分間トーク導入', result: '離職率10-20%→1-2%に改善', period: '6ヶ月' },
            { action: '定期研修実施', result: '退職者大幅削減', period: '継続' },
            { action: '幹部会運用', result: '自費収入過去一を達成', period: '1年' },
            { action: 'クリーンスタッフ採用', result: '正社員が定時帰宅可能に', period: '即効' }
        ],
        staffRecruitment: [
            { action: '採用フェス強化', result: 'プレゼン投票1位、ブース訪問71名、19名見学', period: '1日' },
            { action: '学校連携', result: '学生4名獲得、1名就職希望', period: '1年' },
            { action: '実習生おもてなし', result: '毎年実習生が就職を実現', period: '継続' },
            { action: 'つながり採用', result: '新人Drから1名見学確保', period: '随時' }
        ],
        efficiency: [
            { action: 'クリーンスタッフ採用', result: '片付け時間削減、残業時間ダウン', period: '即効' },
            { action: '診療時間内ブログ作成', result: '月12〜15本投稿を実現', period: '継続' },
            { action: '電子サブカルテ導入', result: 'カルテ探し時間1日1時間以上削減', period: '1ヶ月' }
        ]
    },

    // ========================================
    // 詳細な戦術データベース（数値に応じた分岐用）
    // ========================================
    DETAILED_TACTICS: {
        newPatient: {
            // 新患数が少ない場合（月20人未満）の優先施策
            critical: [
                {
                    id: 'meo_basic',
                    title: 'Googleビジネスプロフィール（MEO）基本最適化',
                    description: '現代の患者の多くは「地域名＋歯科」で検索し、Googleマップ上の評価を見て来院を決めます。初診の4割が「Googleの口コミを見て」来院した事例もあります。',
                    priority: 'highest',
                    steps: [
                        'NAP情報（店舗名・住所・電話番号）をHP・SNSと完全一致させる',
                        '営業時間を正確に保ち、祝祭日は1週間前に更新',
                        'サービス項目に強化治療キーワードを盛り込む',
                        '院内写真を週1回以上アップロード',
                        '投稿機能で季節のお知らせ・症例紹介を定期配信'
                    ],
                    effect: '口コミ56件→116件、新患25人→56人/月（実績事例）',
                    difficulty: '低',
                    period: '効果発現まで2-3ヶ月',
                    cost: '無料〜月1万円程度'
                },
                {
                    id: 'review_system',
                    title: '口コミ獲得の仕組み化',
                    description: '評価4.8以上・口コミ100件以上を目標に計画的に収集。口コミは「見せる接客」です。',
                    priority: 'high',
                    steps: [
                        '口コミ依頼タイミングを設定（治療完了時、メンテナンス移行時等）',
                        '各ユニット・待合室・トイレにQRコード付きチラシを設置',
                        '口コミ依頼トークスクリプトを作成しスタッフ全員で練習',
                        '特定キーワード（痛くない、丁寧な説明等）を含めてもらうよう依頼',
                        '全件24時間以内に丁寧に返信（AI活用も有効）'
                    ],
                    effect: '口コミ数2倍、新患+35%',
                    difficulty: '低',
                    period: '即効性あり',
                    cost: '無料'
                }
            ],
            // 新患数が平均以下の場合（月20-35人）
            low: [
                {
                    id: 'hp_seo',
                    title: 'ホームページ・SEO対策の強化',
                    description: 'E-E-A-T（経験・専門性・権威性・信頼性）を意識したコンテンツ作りで検索上位を目指します。',
                    priority: 'high',
                    steps: [
                        '週1〜2回、1,500文字以上のブログを継続投稿',
                        'AI（ChatGPT等）で構成案→院長が専門家視点で精査',
                        '患者が検索するキーワードを意識（地域名+治療名）',
                        '症例ブログに主訴・悩み・治療期間・費用・Before/After掲載',
                        '第5週診療時間を活用してブログ書き溜め時間を確保'
                    ],
                    effect: 'SEO順位11位→4位、月間38,000PV達成（実績）',
                    difficulty: '中',
                    period: '効果発現まで3-6ヶ月',
                    cost: '内製なら無料、外注で月5-30万円'
                },
                {
                    id: 'web_booking',
                    title: 'WEB予約システムの最適化',
                    description: '新患は深夜や早朝に歯科医院を探す傾向があります。24時間予約可能な環境で取りこぼしを防ぎます。',
                    priority: 'high',
                    steps: [
                        'HPの目立つ場所（ファーストビュー）に予約ボタン設置',
                        '初診枠をリアルタイム開放、DH枠でも受入可能に設定',
                        '予約メニューを「痛みなし・検診希望」等に絞り入口を広げる',
                        'LINE予約連携でより手軽な予約動線を構築',
                        'WEB問診を予約完了メールやLINEに添付'
                    ],
                    effect: 'WEB予約導入初月で30件獲得（実績）',
                    difficulty: '低',
                    period: '即効性あり',
                    cost: '月1-3万円'
                }
            ],
            // 新患数が平均的な場合（月35-60人）
            average: [
                {
                    id: 'lp_ppc',
                    title: 'ランディングページ（LP）とPPC広告',
                    description: '自費診療（矯正、インプラント等）の新患を増やすには、専用LPとリスティング広告が最も効率的です。',
                    priority: 'high',
                    steps: [
                        '強化したい自費メニュー専用の1ページ完結型LP作成',
                        '競合との差別化ポイント（専門医・最新設備・保証等）を明確に',
                        '院長やスタッフの動画をLPに埋め込み',
                        '月3万円以上の予算でPPC広告運用',
                        'キャンセル発生時に当日空き状況をPPC配信'
                    ],
                    effect: '矯正LP作成後1ヶ月で契約4件、月間300万円以上の自費売上（実績）',
                    difficulty: '中',
                    period: '効果発現まで1-2ヶ月',
                    cost: '月3-10万円'
                },
                {
                    id: 'sns_branding',
                    title: 'SNSブランディング（Instagram・YouTube）',
                    description: 'リール動画はフォロワー以外への拡散力が非常に高く、潜在患者へのリーチに効果的です。',
                    priority: 'medium',
                    steps: [
                        '写真中心からリール動画へシフト（週2-3回投稿）',
                        '60秒以内で患者の悩み・疑問に答える動画を量産',
                        'コンテンツ例：痛くない麻酔の工夫、院内ツアー、滅菌の裏側',
                        '症例Before/Afterをプライバシー配慮しつつ公開',
                        '楽しそうな職場雰囲気の発信は採用にも直結'
                    ],
                    effect: '症例発信で月3〜5名来院、ほぼ100%自費治療（実績）',
                    difficulty: '低',
                    period: '効果発現まで1-2ヶ月',
                    cost: '無料〜月数千円'
                }
            ],
            // 新患数が良好な場合（月60人以上）
            good: [
                {
                    id: 'community',
                    title: '地域コミュニティ・アナログ施策',
                    description: 'デジタルに加え、地域密着活動で「いつか行ってみたい」という見込み患者を意図的に作ります。',
                    priority: 'medium',
                    steps: [
                        '「歯医者さん体験イベント」を夏休みに開催（キッザニア形式）',
                        '白衣を着て模型で実習、子供をファンに→家族全体の来院へ',
                        '幼稚園・小学校での「お口の健康」講演',
                        '近隣内科（特に糖尿病クリニック）と医科歯科連携',
                        '医科歯科連携は保険点数アップ（医管・総医）にも寄与'
                    ],
                    effect: '「小児を制する者は経営を制する」家族全体の来院に繋がる',
                    difficulty: '中',
                    period: '効果発現まで3-6ヶ月',
                    cost: 'イベント費用のみ'
                },
                {
                    id: 'referral',
                    title: '紹介カードの仕組み化',
                    description: '満足度の高いタイミングで紹介を依頼し、質の高い新患を獲得します。',
                    priority: 'medium',
                    steps: [
                        '紹介者・新患双方にメリットある紹介カード作成',
                        '院長・担当衛生士が「お困りの方がいれば」と一言添えて手渡し',
                        'メンテナンス終了時など満足度高いタイミングで依頼',
                        '「初診パック」（パンフレット+紹介カード）で家族単位の来院促進',
                        '紹介実績を可視化し、スタッフの意識を高める'
                    ],
                    effect: '質の高い紹介患者は定着率・自費率ともに高い',
                    difficulty: '低',
                    period: '即効性あり',
                    cost: '印刷費のみ'
                }
            ]
        },
        selfPay: {
            critical: [
                {
                    id: 'counseling_basic',
                    title: '三段階カウンセリングシステムの構築',
                    description: '自費率を安定させるには、場当たり的な説明ではなく初診から補綴決定までの「流れ」を仕組み化することが最優先です。',
                    priority: 'highest',
                    steps: [
                        '①初診カウンセリング：主訴だけでなく潜在的な不安・理想・過去の不満をヒアリング',
                        '②セカンドカウンセリング：30分確保し「なぜ悪くなったか」「放置すると将来どうなるか」を視覚的に説明',
                        '③補綴コンサル：「松・竹・梅」3パターンの見積書提示（ゴルディロックス効果活用）',
                        '④終了コンサル：Before/After比較で満足度を高め、紹介カード・口コミ依頼',
                        '専用カウンセリングルームを確保しプライバシーに配慮'
                    ],
                    effect: '自費率1.5〜1.8倍の実績',
                    difficulty: '中',
                    period: '効果発現まで1-2ヶ月',
                    cost: '内製可能'
                },
                {
                    id: 'visual_tools',
                    title: '視覚情報（可視化ツール）の徹底活用',
                    description: '人間は視覚情報から受ける影響が55%と最も大きいため、「見える化」が重要です。',
                    priority: 'high',
                    steps: [
                        '40インチ以上の大型モニターで口腔内写真・パノラマを詳細に見せる',
                        '治療前後の比較写真（症例集）で具体的ゴールをイメージさせる',
                        '写真に書き込みした「お口の状態解説書」を印刷し自宅で家族と相談可能に',
                        '実際の補綴模型を直接触ってもらい素材の価値を直感的に理解',
                        'ジルコニアと銀歯の重さ・質感・滑らかさの違いを体感'
                    ],
                    effect: '説明ツールで成約率+20〜30%',
                    difficulty: '低',
                    period: '即効性あり',
                    cost: 'モニター・模型購入費'
                }
            ],
            low: [
                {
                    id: 'tc_training',
                    title: 'TC（トリートメントコーディネーター）の育成',
                    description: '院長が全てのコンサルを行うのは時間的に限界があるため、DHやDAをTCとして育成します。',
                    priority: 'high',
                    steps: [
                        'TC育成塾などの外部セミナーを活用',
                        'マニュアルやトークスクリプトを整備',
                        '院長とTCの事前カンファレンス（1-2分）で治療方針すり合わせ',
                        '矯正相談枠設定のためTC枠を確保',
                        '成約率を定期的に測定しPDCA'
                    ],
                    effect: '院長の負担軽減と成約率向上の両立',
                    difficulty: '中',
                    period: '効果発現まで2-3ヶ月',
                    cost: 'セミナー費用'
                },
                {
                    id: 'mind_block',
                    title: 'スタッフの「マインドブロック」解除',
                    description: '自費が上がらない最大の原因は、スタッフ自身の「自費は高いから悪い」という思い込みです。',
                    priority: 'high',
                    steps: [
                        '「3つのため」の意識統一：患者様のため・医院のため・自分のため',
                        '「自分が歯科医師なら家族にどの素材を入れるか」を議論',
                        '「あり方教育」：お金を頂くこと＝悪いことという障壁を取り除く',
                        '自費治療を受けた患者様の喜びの声を共有',
                        '自費目標達成時に「大入り袋」でモチベーション維持'
                    ],
                    effect: 'スタッフの自信がつき自然な自費提案が可能に',
                    difficulty: '中',
                    period: '効果発現まで1-2ヶ月',
                    cost: '勉強会費用のみ'
                }
            ],
            average: [
                {
                    id: 'itero_mft',
                    title: '小児矯正・MFT（口腔機能療法）の導入',
                    description: '口腔機能発達不全症と関連付けた小児矯正・MFTは、自費率向上の有力な柱となります。',
                    priority: 'high',
                    steps: [
                        'ターゲット：4〜8歳で歯列不正・お口ぽかん・口呼吸がある患者',
                        '初診時に歯列不正チェック→該当者抽出',
                        '2回目にiTeroスキャン→3回目にカウンセリングの流れを仕組み化',
                        '初期はドクター説明→段階的に衛生士へ移譲',
                        'ユニット外（通路など）でMFT指導し診療効率UP'
                    ],
                    effect: 'MFT導入で月6万→月280万体制（実績）、小児矯正成約率85%',
                    difficulty: '中',
                    period: '効果発現まで3-6ヶ月',
                    cost: 'iTero導入費用'
                },
                {
                    id: 'dental_loan',
                    title: '支払いハードルの緩和（デンタルローン導入）',
                    description: '良い治療だと分かっても最後の壁は「費用」。これを仕組みで解消します。',
                    priority: 'medium',
                    steps: [
                        'デンタルローン（アプラス等）導入で月々数千円単位に',
                        '「24回まで手数料無料（医院負担）」キャンペーンで成約ハードル劇的低下',
                        '期間限定キャンペーン（開院記念、モニター等）で「限定感」演出',
                        '見積書に「一括」と「分割」の両方を必ず記載',
                        '人は期限があるものに対して決断を早める傾向を活用'
                    ],
                    effect: '高額治療の成約率+40%',
                    difficulty: '低',
                    period: '即効性あり',
                    cost: '手数料のみ'
                }
            ],
            good: [
                {
                    id: 'project_team',
                    title: 'プロジェクトチームによる組織的アプローチ',
                    description: '院長一人で頑張るのではなく、スタッフに役割を分散し自発的に動く仕組みを作ります。',
                    priority: 'medium',
                    steps: [
                        '「自費率アッププロジェクトチーム」の発足',
                        'スタッフから担当者を決め目標数値管理やツール改善を任せる',
                        '月次目標契約数・自費率をGoogleスプレッドシートで可視化',
                        '朝礼やミーティングで進捗共有',
                        '目標達成時に「大入り袋」でチーム全体のモチベーション維持'
                    ],
                    effect: 'インプラント月1→6症例、自費400万→1,000万（実績）',
                    difficulty: '中',
                    period: '効果発現まで3-6ヶ月',
                    cost: '報奨金程度'
                }
            ]
        },
        cancel: {
            critical: [
                {
                    id: 'immediate_call',
                    title: '無断キャンセルへの即時架電',
                    description: '予約時間を過ぎても来院されない場合、すぐに電話をかけることで再予約率が大幅に上がります。',
                    priority: 'highest',
                    steps: [
                        '予約時間を5〜10分過ぎたらその場ですぐ電話',
                        '「事故やトラブルに遭われていないか心配で」というスタンス',
                        '責めずに再予約を促す',
                        '電話に出ない場合はSMS/LINEでフォロー',
                        '無断キャンセル回数を記録し傾向を分析'
                    ],
                    effect: '無断キャンセルからの再予約率大幅向上',
                    difficulty: '低',
                    period: '即効性あり',
                    cost: '無料'
                },
                {
                    id: 'reminder_auto',
                    title: '2段階リマインドの自動化',
                    description: '予約忘れによるキャンセルを防止し、来院率を向上させます。',
                    priority: 'highest',
                    steps: [
                        '予約の「1週間前」と「前日」にSMS/LINE自動送信',
                        '1週間前：「変更がある場合はお早めにご連絡ください」',
                        '前日：「明日のご来院をお待ちしております」',
                        '新患・長時間枠は2日前に確認電話を追加',
                        'リマインドメッセージの文面を定期的に改善'
                    ],
                    effect: 'キャンセル率-40%の実績',
                    difficulty: '低',
                    period: '即効性あり',
                    cost: 'SMS送信費のみ'
                }
            ],
            low: [
                {
                    id: 'cancel_policy',
                    title: 'キャンセルポリシーの明文化と事前説明',
                    description: '患者に「予約を守ることが自分の利益につながる」と理解してもらう教育的アプローチです。',
                    priority: 'high',
                    steps: [
                        '「予約変更は前日まで」「無断キャンセル続く場合は当日予約のみ」を明文化',
                        '待合室・ユニット・トイレに「予約制の考え方」を掲示',
                        '初診カウンセリング時にポリシーを丁寧に説明',
                        '書面で「患者さまとのお約束」を作成し署名をいただく',
                        '「予約」ではなく「お約束」という言葉で心理的価値を高める'
                    ],
                    effect: '当日キャンセル-30%',
                    difficulty: '低',
                    period: '効果発現まで2週間',
                    cost: '印刷費のみ'
                },
                {
                    id: 'future_projection',
                    title: '「未来観測」と「仮説質問」による患者教育',
                    description: '「痛みがなくなったから行かなくてもいい」という中断を防ぎます。',
                    priority: 'high',
                    steps: [
                        '「中断すると数年後には抜歯→インプラント必要」と具体的に伝える',
                        '放置した場合の最悪シナリオを動画や資料で説明',
                        '「今日で終わりではありません」と毎回声かけ',
                        '「お仕事が忙しくなっても通い続けられますか？」と事前確認',
                        '本人から「通います」というコミットメントを引き出す'
                    ],
                    effect: '中断患者の大幅減少',
                    difficulty: '低',
                    period: '効果発現まで1ヶ月',
                    cost: '無料'
                }
            ],
            average: [
                {
                    id: 'chairside_booking',
                    title: 'チェアサイドでの次回予約',
                    description: '受付ではなく、最も信頼関係を築いているDHが診療室で次回予約を取ることで心理的ハードルを上げます。',
                    priority: 'medium',
                    steps: [
                        'DHが「この部位は3ヶ月後に再確認必要」と個別理由を添えて提案',
                        '受付へ誘導する前に診療室内でアポイント確定',
                        '予約の重要性が増し受付の負担軽減にも',
                        '予約カードをチェアサイドで手渡し',
                        '予約確定率を測定しPDCA'
                    ],
                    effect: '無断キャンセル-50%',
                    difficulty: '低',
                    period: '即効性あり',
                    cost: '無料'
                },
                {
                    id: 'cancel_recovery',
                    title: 'キャンセル枠を無駄にしないリカバリー体制',
                    description: 'どれだけ対策してもキャンセルは発生します。それを「損失」にしない仕組みを作ります。',
                    priority: 'medium',
                    steps: [
                        '予約取れなかった患者に「空き連絡希望」を確認しリスト化',
                        '空きが出た瞬間にLINE/電話で一斉・個別連絡',
                        '当日・翌日の空き状況をLINEやSNSで配信',
                        'キャンセル発生時に即座にネット予約開放',
                        'キャンセル待ち→来院の転換率を測定'
                    ],
                    effect: '稼働率+15〜20%向上',
                    difficulty: '中',
                    period: '効果発現まで1ヶ月',
                    cost: '無料〜システム費'
                }
            ],
            good: [
                {
                    id: 'cancel_metrics',
                    title: 'キャンセル数値の可視化と共有',
                    description: 'スタッフ全員がキャンセルの影響を「自分事」として捉える当事者意識を醸成します。',
                    priority: 'medium',
                    steps: [
                        '「キャンセル率」ではなく「予約遂行率」というポジティブ指標で目標設定',
                        '毎日の終礼で無断キャンセル数・電話キャンセル数・予約遂行率を報告',
                        '月1回の全体会議で「なぜキャンセルしたか」「どう防げたか」を話し合う',
                        '目標達成時には報奨金（大入り袋）で還元',
                        '曜日・時間帯別のキャンセル傾向を分析'
                    ],
                    effect: '質の高い患者が集まる健全な経営基盤構築',
                    difficulty: '低',
                    period: '効果発現まで1ヶ月',
                    cost: '報奨金程度'
                }
            ]
        },
        staffRetention: {
            critical: [
                {
                    id: 'five_min_talk',
                    title: '5分間トーク（1on1）の定着',
                    description: '終礼時に教育担当と新人が1対1で毎日5分間の振り返りを実施。この習慣で定着率が10倍になることが証明されています。',
                    priority: 'highest',
                    steps: [
                        '終礼時に教育担当と新人が1対1で5分間振り返り',
                        'できたことを承認し、明日から実践することを明確に',
                        '毎日継続することが重要（週1では効果半減）',
                        '日誌を通じて交換日記感覚で悩みや質問を吸い上げ',
                        '先輩からのプラスコメントが新人のモチベーションに直結'
                    ],
                    effect: '離職率10-20%→1-2%に改善（実績）',
                    difficulty: '低',
                    period: '効果発現まで1-3ヶ月',
                    cost: '無料'
                },
                {
                    id: 'orientation_multi',
                    title: '3ヶ月にわたる多段階オリエンテーション',
                    description: '単なる「やり方」の伝達ではなく、医院の「あり方（理念・考え方）」を浸透させ、価値観のズレによる早期離職を防ぎます。',
                    priority: 'highest',
                    steps: [
                        '1ヶ月目：医院の規律、理念、3つのため（患者・医院・自分）を説明',
                        '2ヶ月目：社会人・医療人としての「あり方」、理想のスタッフ像',
                        '3ヶ月目：チームワークの大切さ、プロジェクト活動の意味付け',
                        '3ヶ月後の本採用テスト合格時に正式な制服・名札を授与',
                        '家族を巻き込んだ入社式で帰属意識を高める'
                    ],
                    effect: '早期離職の大幅減少',
                    difficulty: '中',
                    period: '効果発現まで3ヶ月',
                    cost: '内製可能'
                }
            ],
            low: [
                {
                    id: 'education_system',
                    title: '「教育の仕組み化」による不安の解消',
                    description: '新人が離職する大きな理由は、教育体制が整わず「成長できているか分からない」という不安です。',
                    priority: 'high',
                    steps: [
                        'スプレッドシートで1年間の習得ロードマップを明確化',
                        '進捗を可視化し先が見えない不安を取り除く',
                        '動画マニュアル作成（器具準備、片付け、カウンセリングトーク等）',
                        'いつでもスマホやタブレットで復習できる環境整備',
                        '教える側の負担を減らし教育の質を均一化'
                    ],
                    effect: 'スキルアップで満足度+40%',
                    difficulty: '中',
                    period: '効果発現まで2-3ヶ月',
                    cost: '動画作成費用'
                },
                {
                    id: 'sister_system',
                    title: 'シスター制度（メンター制度）と日誌交換',
                    description: '業務を教える「教育担当」とは別に、メンタル面をサポートする「シスター」を任命します。',
                    priority: 'high',
                    steps: [
                        '年齢の近い先輩が相談役となり心理的安全性を高める',
                        '毎日の日誌を通じて交換日記感覚で悩みを吸い上げ',
                        '業務の質問と悩み相談の窓口を分ける',
                        'シスターとの定期ランチで関係構築',
                        '先輩スタッフの成長機会にもなる'
                    ],
                    effect: '心理的安全性の向上、早期離職防止',
                    difficulty: '低',
                    period: '効果発現まで1ヶ月',
                    cost: '無料'
                }
            ],
            average: [
                {
                    id: 'labor_evaluation',
                    title: '労務環境と評価制度の整備',
                    description: 'スタッフのやる気を引き出す前に、まず「不満（負の感情）」をゼロにする土台作りが必要です。',
                    priority: 'high',
                    steps: [
                        '有給休暇の計画的付与、残業代の適正支払い、健康診断の実施',
                        '「職能要件書」で技術スキル（定量）と行動原則（定性）を評価',
                        'どのランクで給与がいくらか明確にし将来への不安を解消',
                        '社労士と連携して整備',
                        '目標達成時に「大入り袋」でチーム全体の達成意欲を維持'
                    ],
                    effect: '離職率-35%の改善',
                    difficulty: '高',
                    period: '効果発現まで3-6ヶ月',
                    cost: '社労士費用'
                },
                {
                    id: 'communication_quality',
                    title: 'コミュニケーションの質と頻度の向上',
                    description: '「疑問→不安→不満→退職」というプロセスを辿る前に、日々の小さなズレを修正します。',
                    priority: 'medium',
                    steps: [
                        '3ヶ月に一度は院長または幹部が20-30分の個別面談',
                        '業務進捗だけでなく将来の理想像やプライベートも把握',
                        '「スタッフカルテ」作成：家族構成、趣味、好きなもの、価値観を記録',
                        '誕生日サプライズやお土産選びに活用',
                        'サンキューカードでスタッフ間の感謝を伝え合う'
                    ],
                    effect: '「自分のことを見てくれている」という安心感',
                    difficulty: '低',
                    period: '効果発現まで1ヶ月',
                    cost: '無料'
                }
            ],
            good: [
                {
                    id: 'executive_meeting',
                    title: '幹部会運用と院長との信頼関係構築',
                    description: '組織が大きくなるにつれ、院長一人での情報伝達には限界があります。',
                    priority: 'medium',
                    steps: [
                        '各職種1名以上が参加する幹部会で情報伝達ミスを減少',
                        '院長の方針を幹部が現場に伝達する二段階コミュニケーション',
                        '「院長が〇〇さんを褒めていた」と幹部が代弁（ボイスチェンジ）',
                        '第三者を介することで称賛の信憑性が増す',
                        '年1-2回の理念共有会で同じ方向を向くチームを作る'
                    ],
                    effect: '幹部会運用で自費収入過去一達成（実績）',
                    difficulty: '中',
                    period: '効果発現まで3-6ヶ月',
                    cost: '会議費用のみ'
                }
            ]
        },
        staffRecruitment: {
            critical: [
                {
                    id: 'referral_max',
                    title: 'つながり採用（リファラル）の最大活用',
                    description: '最も定着率が高くミスマッチが少ないのが「つながり採用」。満足の先にしかつながり採用は成立しません。',
                    priority: 'highest',
                    steps: [
                        '紹介採用時の報酬を明示（例：入社時10万円、試用期間終了時10万円）',
                        '紹介してくれたスタッフとの食事代を医院負担',
                        '母校・部活動の後輩へ定期的に連絡',
                        '食事会などを通じて関係性を維持',
                        'メンテナンス患者の中から自院に合いそうな人財に声かけ'
                    ],
                    effect: '定着率が極めて高い人財を確保',
                    difficulty: '低',
                    period: '効果発現まで1-3ヶ月',
                    cost: '紹介報酬'
                },
                {
                    id: 'school_partnership',
                    title: '学校連携と実習生戦略',
                    description: 'DH採用の最も確実なルートは、実習生を自院のファンにすることです。',
                    priority: 'highest',
                    steps: [
                        '毎年決まった時期に就職担当の先生を訪問（手土産持参）',
                        '卒業生DHを同行させ現場の声を直接届ける',
                        '国家試験前に応援動画や合格祈願のお守りを贈る',
                        '実習生を「掃除係」扱いせず歓迎（ウェルカムボード等）',
                        '最終日に色紙や花束でサプライズお別れ会'
                    ],
                    effect: '毎年実習生が就職を実現（実績）、学生4名獲得',
                    difficulty: '中',
                    period: '効果発現まで6ヶ月-1年',
                    cost: '訪問費用、お礼品'
                }
            ],
            low: [
                {
                    id: 'job_site_optimize',
                    title: '求人サイト・SNSの最適化',
                    description: '求職者は応募前に必ず医院のWebサイトやSNSを確認します。「選ばれる」仕組みを作ります。',
                    priority: 'high',
                    steps: [
                        '写真に文字を入れて加工し求職者の目に留まるように',
                        'スカウトメールは毎日送信（相手に合わせてカスタマイズ）',
                        '最初の3行で惹きつける文面に',
                        '条件羅列ではなく理念・教育カリキュラム・先輩の成長ストーリーを掲載',
                        'リール動画でスタッフの笑顔や診療中の雰囲気を発信'
                    ],
                    effect: '応募数+50%、採用単価-30%',
                    difficulty: '低',
                    period: '効果発現まで1-2ヶ月',
                    cost: '求人サイト掲載費'
                },
                {
                    id: 'recruitment_page',
                    title: '採用専用ページの充実',
                    description: '医院の理念、教育カリキュラム、福利厚生、1日の流れなどを詳しく掲載します。',
                    priority: 'high',
                    steps: [
                        '求人文章は他院の5倍以上の情報量を目指す',
                        'スタッフインタビュー動画（入社理由、やりがい）を掲載',
                        '楽しそうな休憩時間や福利厚生を発信',
                        '1日のスケジュールを写真付きで紹介',
                        'よくある質問（Q&A）を充実'
                    ],
                    effect: '応募前の不安解消、ミスマッチ防止',
                    difficulty: '中',
                    period: '効果発現まで1ヶ月',
                    cost: 'ページ制作費'
                }
            ],
            average: [
                {
                    id: 'selection_process',
                    title: 'ミスマッチを防ぐ選考プロセス',
                    description: '「猫の手採用」は後のトラブルや既存スタッフの離職を招く最大の失敗です。',
                    priority: 'high',
                    steps: [
                        '見学→1次面接（幹部）→2次面接（作文・テスト）→3次面接（院長）の多段階選考',
                        '「FIRST」等の適性検査で性格・行動傾向を客観把握',
                        '体験入社（1日〜数日）でスタッフ全員が評価',
                        '「この人と一緒に働きたいか」を全員で確認',
                        '迎える側の責任感も醸成'
                    ],
                    effect: '内定承諾率+40%、ミスマッチ大幅減少',
                    difficulty: '中',
                    period: '即効性あり',
                    cost: '適性検査費用'
                },
                {
                    id: 'post_offer_follow',
                    title: '内定後フォローと入社式',
                    description: '採用決定後も入社までの辞退を防ぎ、入社初日の不安を払拭します。',
                    priority: 'medium',
                    steps: [
                        '院長の直筆手紙や挨拶状をご家族へ送る',
                        '国家試験前に合格祈願のお守りを贈る',
                        '入社初日にしっかりとした入社式を実施',
                        '技術（やり方）の前にマインド（あり方）を教育',
                        '家族から預かった激励の手紙をサプライズで読む'
                    ],
                    effect: '入社前辞退の防止、帰属意識の向上',
                    difficulty: '低',
                    period: '即効性あり',
                    cost: '手紙・お守り程度'
                }
            ],
            good: [
                {
                    id: 'recruitment_event',
                    title: '採用フェス・イベントでの勝ち方',
                    description: '合同説明会で埋もれないための差別化戦略です。',
                    priority: 'medium',
                    steps: [
                        '巨大背景パネル・うちわ作戦で目を引く',
                        '全員がiPadで説明できるよう準備',
                        'GoogleフォームアンケートでLINE交換',
                        'SNSリアルタイム更新で盛り上がりをアピール',
                        '2分間プレゼンで印象に残るストーリーを語る'
                    ],
                    effect: 'プレゼン投票1位、ブース訪問71名、19名見学（実績）',
                    difficulty: '中',
                    period: 'イベント当日',
                    cost: 'ブース装飾費'
                }
            ]
        },
        efficiency: {
            critical: [
                {
                    id: 'task_shift',
                    title: '「ボトルネック理論」に基づくタスクシフト',
                    description: '歯科医院の最大のボトルネックはDr。Drでなければできない業務以外を他職種へ移管し、生産性を向上させます。',
                    priority: 'highest',
                    steps: [
                        'DHへのタスクシフト：浸潤麻酔セミナー受講で認定DHが麻酔実施',
                        'クリーンスタッフ（CS）採用：後片付け、滅菌、準備、写真整理を専任パートに',
                        'DHや助手が診療に専念できる環境構築',
                        'WEB専門スタッフ：HP更新・SNS運用を専任',
                        '任せたい業務内容・条件面は入社前にすり合わせ'
                    ],
                    effect: 'クリーンスタッフ採用で残業時間ダウン（実績）',
                    difficulty: '中',
                    period: '効果発現まで1-2ヶ月',
                    cost: 'パート人件費'
                },
                {
                    id: 'reception_digital',
                    title: '受付業務のデジタル化（受付ゼロ化計画）',
                    description: '受付はミスが発生しやすく心理的負担も大きい部署。デジタル化で24時間対応可能なサービスを提供。',
                    priority: 'highest',
                    steps: [
                        '24時間対応WEB予約を導入、既存患者の変更もLINEで完結',
                        '自動精算機とキャッシュレス決済で会計待ち時間を20分→数分に',
                        'ユニットサイドで会計金額確定→患者が直接機械で支払うフロー',
                        '診察券アプリへ移行し紙の発行・記入・紛失対応をゼロに',
                        '同意書・個人情報取り扱い同意書をペーパーレスで管理'
                    ],
                    effect: '受付業務-30%の効率化',
                    difficulty: '中',
                    period: '効果発現まで1-2ヶ月',
                    cost: '自動精算機・システム費'
                }
            ],
            low: [
                {
                    id: 'paperless',
                    title: 'ペーパーレス化とデータの一元管理',
                    description: '紙資料の出し入れや管理にかかる時間は積み重なると膨大なロスになります。',
                    priority: 'high',
                    steps: [
                        '電子カルテ・電子サブカルテへの完全移行',
                        '各ユニットのiPadから即座にアクセス・記入可能に',
                        'カルテを探す・運ぶ・戻す時間を完全排除',
                        'WEB問診システム導入で受付滞在時間短縮',
                        'Googleサイト等で院内ポータルを構築しマニュアル・就業規則を一元管理'
                    ],
                    effect: 'カルテ探し1日1時間以上削減（実績）',
                    difficulty: '中',
                    period: '効果発現まで1-2ヶ月',
                    cost: 'システム導入費'
                },
                {
                    id: 'video_manual',
                    title: '動画マニュアルによる教育の効率化',
                    description: '「何度も同じことを教える」時間を削減し、教育の質を均一化します。',
                    priority: 'high',
                    steps: [
                        '器具の準備、片付け、術式、接遇などを動画で撮影',
                        'iPhone等で撮影しYouTube限定公開や専用システムで共有',
                        '新人は自宅や隙間時間に予習・復習が可能',
                        '指導者の拘束時間を最小限に抑え技術の標準化を実現',
                        'スプレッドシートで進捗管理を可視化'
                    ],
                    effect: '教育時間の大幅削減、属人化解消',
                    difficulty: '中',
                    period: '効果発現まで2-3ヶ月',
                    cost: '撮影機材・システム費'
                }
            ],
            average: [
                {
                    id: 'ai_tools',
                    title: 'AIツールの活用',
                    description: '最新のAI技術を活用して業務効率を飛躍的に向上させます。',
                    priority: 'medium',
                    steps: [
                        'AI音声入力・要約ツール（PLAUD NOTE等）でカウンセリング内容を自動記録',
                        'AIセファロ分析（WEBCEPH）で矯正診断効率化',
                        'ChatGPTで口コミ返信、ブログ構成案、トークスクリプト作成',
                        '記録業務の時間を大幅に短縮',
                        'AI活用のルール・ガイドラインを整備'
                    ],
                    effect: '記録業務-50%以上削減',
                    difficulty: '中',
                    period: '効果発現まで1ヶ月',
                    cost: 'ツール利用料'
                },
                {
                    id: 'communication_tools',
                    title: '院内コミュニケーションツールの最適化',
                    description: '情報伝達のスピードと正確性を高めます。',
                    priority: 'medium',
                    steps: [
                        'Apple Watch・チャットツール（チャットワーク、LINE WORKS等）でインカム代替',
                        '耳を塞がないため患者との会話を遮らない',
                        '履歴が残るため聞き逃しを防止',
                        '緊急時の一斉送信も迅速に',
                        'スタッフ間連絡のルールを明確化'
                    ],
                    effect: '情報共有速度3倍',
                    difficulty: '低',
                    period: '即効性あり',
                    cost: 'ツール利用料'
                }
            ],
            good: [
                {
                    id: 'standardization',
                    title: 'マニュアル整備と業務の標準化',
                    description: '属人化を防ぎ、誰でも同じ品質のサービスを提供できる体制を作ります。',
                    priority: 'medium',
                    steps: [
                        'ネット予約運用ルールの明確化',
                        'キャンセル対応の属人化防止',
                        '口コミ依頼トークスクリプトの作成',
                        '第5週診療時間の活用でブログ書き溜め',
                        '定期的な見直し・更新サイクルの確立'
                    ],
                    effect: '月12〜15本ブログ投稿実現（実績）',
                    difficulty: '中',
                    period: '効果発現まで2-3ヶ月',
                    cost: '内製可能'
                }
            ]
        }
    },

    // ========================================
    // 業界ベンチマーク（業界平均値）
    // ========================================
    INDUSTRY_BENCHMARKS: {
        // 新患数（人/月）
        newPatient: {
            low: 20,
            average: 35,
            high: 60,
            excellent: 80
        },
        // 1日来院数（人/日）
        dailyVisit: {
            low: 20,
            average: 35,
            high: 55,
            excellent: 75
        },
        // 月間保険収入（万円）
        insurance: {
            low: 300,
            average: 500,
            high: 800,
            excellent: 1200
        },
        // 月間自費収入（万円）
        selfPay: {
            low: 50,
            average: 150,
            high: 350,
            excellent: 600
        },
        // 自費率（%）
        selfPayRate: {
            low: 8,
            average: 15,
            high: 25,
            excellent: 35
        },
        // キャンセル率（%）- 低いほど良い
        cancel: {
            excellent: 3,
            high: 5,
            average: 7,
            low: 10
        },
        // リコール率（%）
        recall: {
            low: 30,
            average: 50,
            high: 65,
            excellent: 80
        },
        // レセプト枚数（枚/月）
        receipt: {
            low: 400,
            average: 800,
            high: 1500,
            excellent: 2500
        }
    },

    // ========================================
    // 地域別の特性データ
    // ========================================
    REGIONAL_DATA: {
        hokkaido: { competition: 'low', avgRevenue: 550, growthPotential: 'medium' },
        tohoku: { competition: 'low', avgRevenue: 480, growthPotential: 'medium' },
        kanto: { competition: 'high', avgRevenue: 720, growthPotential: 'high' },
        chubu: { competition: 'medium', avgRevenue: 580, growthPotential: 'medium' },
        tokai: { competition: 'medium', avgRevenue: 620, growthPotential: 'high' },
        kinki: { competition: 'high', avgRevenue: 680, growthPotential: 'high' },
        chugoku: { competition: 'low', avgRevenue: 520, growthPotential: 'medium' },
        shikoku: { competition: 'low', avgRevenue: 480, growthPotential: 'low' },
        kyushu: { competition: 'medium', avgRevenue: 540, growthPotential: 'medium' }
    },

    // ========================================
    // 開業年数別の特性データ
    // ========================================
    YEARS_DATA: {
        'under3': { phase: 'growth', challenges: ['newPatient', 'efficiency'], strengths: ['flexibility'] },
        '3to5': { phase: 'establishment', challenges: ['selfPay', 'staffRecruitment'], strengths: ['momentum'] },
        '5to10': { phase: 'maturity', challenges: ['efficiency', 'cancel'], strengths: ['reputation'] },
        '10to20': { phase: 'optimization', challenges: ['staffRetention', 'efficiency'], strengths: ['stability'] },
        'over20': { phase: 'renewal', challenges: ['newPatient', 'efficiency'], strengths: ['trust'] }
    },


    // ========================================
    // 課題別の改善提案データベース
    // ========================================
    RECOMMENDATIONS: {
        // 新患獲得の提案
        newPatient: {
            title: '新患獲得戦略',
            icon: '📈',
            items: [
                {
                    title: 'Googleマップ（MEO）対策の強化',
                    description: '地域検索で上位表示されることで、新患獲得数が大幅に向上します。Googleビジネスプロフィールの最適化が重要です。',
                    steps: [
                        'Googleビジネスプロフィールの情報を100%完成させる',
                        '写真を20枚以上アップロード（院内・スタッフ・治療例）',
                        '投稿機能を活用し、週1回以上の情報発信',
                        '口コミ返信を24時間以内に行う',
                        'Q&A機能でよくある質問に事前回答'
                    ],
                    effect: '類似医院の平均効果：新患 +35%',
                    difficulty: '中',
                    period: '効果発現まで約2-3ヶ月'
                },
                {
                    title: 'ホームページのSEO・コンテンツ改善',
                    description: '検索エンジンからの流入を増やし、ウェブ経由の新患を獲得します。地域名×治療名のキーワードで上位表示を目指します。',
                    steps: [
                        '「地域名 + 歯医者」で検索順位を確認',
                        '各治療ページに地域名を含めたタイトル設定',
                        '症例写真・治療実績ページの充実',
                        'スマートフォン対応の確認と改善',
                        'ページ表示速度の最適化（3秒以内）'
                    ],
                    effect: '検索順位UP → 新患 +15〜25%の実績',
                    difficulty: '高',
                    period: '効果発現まで約3-6ヶ月'
                },
                {
                    title: 'Web予約システムの最適化',
                    description: '24時間予約可能な環境を整え、予約のハードルを下げます。特に若年層からの新患獲得に効果的です。',
                    steps: [
                        '予約フォームの入力項目を最小限に（5項目以下）',
                        'スマートフォンでの操作性を徹底検証',
                        '予約完了メールの自動送信設定',
                        'キャンセル・変更のオンライン化',
                        '空き状況のリアルタイム表示'
                    ],
                    effect: '予約率 平均1.4倍向上',
                    difficulty: '低',
                    period: '即効性あり（導入後すぐ）'
                },
                {
                    title: 'SNS・Instagram活用による認知拡大',
                    description: 'ビジュアル重視のSNSで医院の雰囲気や実績を発信し、潜在患者へのリーチを拡大します。',
                    steps: [
                        'Instagramビジネスアカウントの開設',
                        '院内の明るい写真を定期投稿（週3回）',
                        'スタッフ紹介で親しみやすさをアピール',
                        '治療ビフォーアフター（許可済み）の投稿',
                        '地域のハッシュタグを積極活用'
                    ],
                    effect: '認知度向上 → 新患 +10〜20%',
                    difficulty: '低',
                    period: '効果発現まで約1-2ヶ月'
                }
            ]
        },

        // 自費率向上の提案
        selfPay: {
            title: '自費率向上戦略',
            icon: '💰',
            items: [
                {
                    title: 'カウンセリング強化研修の実施',
                    description: '患者様のニーズを正確に把握し、最適な治療を提案するスキルを向上させます。押し売りではなく、価値の伝達がポイントです。',
                    steps: [
                        'カウンセリング専用スペースの確保',
                        '治療選択肢の説明シートを作成',
                        'スタッフ向けロールプレイング研修（月1回）',
                        '患者様の「本当の希望」を引き出す質問技術',
                        '自費・保険のメリット/デメリット比較表の活用'
                    ],
                    effect: '自費率 平均1.5〜1.8倍の実績',
                    difficulty: '中',
                    period: '効果発現まで約1-2ヶ月'
                },
                {
                    title: '自費メニュー表・説明ツールの改善',
                    description: '視覚的にわかりやすい資料で、患者様の理解と納得を促進します。高額治療への心理的ハードルを下げます。',
                    steps: [
                        '写真入りメニュー表の作成（A4サイズ）',
                        '価格表示は「総額」と「分割」の両方記載',
                        '素材の違いを実物サンプルで説明',
                        'デンタルローン・分割払いの案内追加',
                        'iPad等でのビジュアル説明導入'
                    ],
                    effect: '説明ツールで成約率 +20〜30%',
                    difficulty: '低',
                    period: '即効性あり'
                },
                {
                    title: '症例写真・ビフォーアフターの活用',
                    description: '実際の治療結果を視覚化することで、患者様のイメージを具体化し、治療意欲を高めます。',
                    steps: [
                        '症例写真の撮影体制を整備（同意書含む）',
                        '治療別にビフォーアフター集を作成',
                        '待合室モニターでのスライド表示',
                        'カウンセリング時の症例提示ルーティン化',
                        'ホームページへの症例ギャラリー追加'
                    ],
                    effect: 'ビフォーアフター活用で成約率 +25%',
                    difficulty: '中',
                    period: '効果発現まで約1ヶ月'
                },
                {
                    title: '自費専門時間帯・枠の設定',
                    description: '自費治療に集中できる環境を作り、説明時間を十分に確保します。患者様の満足度と成約率が向上します。',
                    steps: [
                        '週に1-2日、自費カウンセリング専用時間を設定',
                        '初診時に自費希望の有無を確認',
                        'カウンセリング枠は30分以上を確保',
                        '自費患者様用の個室・空間を整備',
                        'ドクター・TCの役割分担を明確化'
                    ],
                    effect: '自費成約率 +30〜40%',
                    difficulty: '中',
                    period: '効果発現まで約1ヶ月'
                }
            ]
        },

        // キャンセル削減の提案
        cancel: {
            title: 'キャンセル削減戦略',
            icon: '📅',
            items: [
                {
                    title: 'リマインド連絡の自動化',
                    description: '予約忘れによるキャンセルを防止し、来院率を向上させます。SMSやLINEによる自動連絡が効果的です。',
                    steps: [
                        '予約管理システムへのリマインド機能導入',
                        '3日前・前日・当日朝の3段階リマインド設定',
                        'SMS/LINEでの連絡（メールより開封率高）',
                        'リマインドメッセージの文面最適化',
                        'キャンセル時の再予約誘導メッセージ'
                    ],
                    effect: 'キャンセル率 -40%の実績',
                    difficulty: '低',
                    period: '即効性あり'
                },
                {
                    title: '予約ルール・キャンセルポリシーの見直し',
                    description: '明確なルールを設けることで、患者様の予約に対する意識を高めます。',
                    steps: [
                        'キャンセルポリシーを明文化',
                        '初診時にポリシーの説明と同意',
                        '無断キャンセル時のフォロー電話ルーティン',
                        '複数回キャンセルへの対応ルール策定',
                        'キャンセル待ちシステムの導入'
                    ],
                    effect: '当日キャンセル -30%',
                    difficulty: '低',
                    period: '効果発現まで約2週間'
                },
                {
                    title: 'LINE公式アカウントによる予約管理',
                    description: 'LINEで簡単に予約変更できる環境を整え、ドタキャンを予約変更に転換します。',
                    steps: [
                        'LINE公式アカウントの開設',
                        '予約確認・変更機能の追加',
                        '友だち追加の積極的な案内',
                        'トーク画面での予約リマインド送信',
                        'キャンセル時の再予約ボタン設置'
                    ],
                    effect: 'ドタキャン → 予約変更転換で -35%',
                    difficulty: '中',
                    period: '効果発現まで約1ヶ月'
                },
                {
                    title: '予約枠の最適化とオーバーブッキング戦略',
                    description: 'キャンセル率を考慮した予約管理で、稼働率を最大化します。データに基づく科学的アプローチです。',
                    steps: [
                        '曜日・時間帯別キャンセル率の分析',
                        'キャンセル率の高い枠に適度なオーバーブッキング',
                        'キャンセル発生時の当日枠解放の仕組み',
                        '急患対応枠の戦略的配置',
                        '月次でのデータ分析と改善サイクル'
                    ],
                    effect: '稼働率 +15〜20%向上',
                    difficulty: '高',
                    period: '効果発現まで約2-3ヶ月'
                }
            ]
        },

        // スタッフ定着の提案
        staffRetention: {
            title: 'スタッフ定着戦略',
            icon: '🤝',
            items: [
                {
                    title: '評価制度・キャリアパスの整備',
                    description: 'スタッフが将来のビジョンを持てる環境を作り、長期的な定着を促進します。',
                    steps: [
                        '職種別・経験年数別の給与テーブル作成',
                        '四半期ごとの評価面談の実施',
                        '昇給・昇格の基準を明文化',
                        'スキルマップによる成長の可視化',
                        '資格取得支援制度の導入'
                    ],
                    effect: '離職率 平均-35%の改善',
                    difficulty: '高',
                    period: '効果発現まで約3-6ヶ月'
                },
                {
                    title: '教育・研修プログラムの構築',
                    description: '体系的な教育でスキルアップを支援し、仕事へのやりがいと満足度を向上させます。',
                    steps: [
                        '入職時研修カリキュラムの作成（2週間プログラム）',
                        '月1回の院内勉強会の実施',
                        '外部セミナー参加費の補助制度',
                        'マニュアル動画のライブラリ化',
                        'メンター制度の導入（先輩スタッフ担当制）'
                    ],
                    effect: 'スキルアップで満足度 +40%',
                    difficulty: '中',
                    period: '効果発現まで約2-3ヶ月'
                },
                {
                    title: 'コミュニケーション・チームビルディング改善',
                    description: '良好な職場環境でチーム力を強化し、スタッフのモチベーションを維持・向上させます。',
                    steps: [
                        '毎朝5分のミーティング（情報共有・目標確認）',
                        '月1回のランチミーティング or 懇親会',
                        'スタッフからの改善提案制度',
                        '感謝を伝える仕組み（サンクスカード等）',
                        '定期的な1on1面談（月1回15分）'
                    ],
                    effect: 'チーム力強化でモチベーション +25%',
                    difficulty: '低',
                    period: '効果発現まで約1ヶ月'
                },
                {
                    title: '働きやすい職場環境の整備',
                    description: 'スタッフが長く働きたいと思える環境を作り、離職防止につなげます。',
                    steps: [
                        '有給休暇取得の促進と管理',
                        '残業時間の削減と業務効率化',
                        '福利厚生の充実（社会保険・退職金制度）',
                        '休憩スペースの改善',
                        'ワークライフバランスへの配慮'
                    ],
                    effect: '従業員満足度 +30%',
                    difficulty: '中',
                    period: '効果発現まで約1-2ヶ月'
                }
            ]
        },

        // スタッフ採用の提案
        staffRecruitment: {
            title: 'スタッフ採用戦略',
            icon: '👥',
            items: [
                {
                    title: '採用力強化・ブランディング',
                    description: '「働きたい医院」としてのブランドを構築し、優秀な人材を獲得します。',
                    steps: [
                        '採用専用ページの作成（スタッフインタビュー含む）',
                        'Indeed・ジョブメドレーへの掲載最適化',
                        'SNSでの職場雰囲気発信',
                        'リファラル採用（紹介）制度の導入',
                        '歯科衛生士学校との連携強化'
                    ],
                    effect: '応募数 +50%、採用単価 -30%',
                    difficulty: '中',
                    period: '効果発現まで約2-3ヶ月'
                },
                {
                    title: '求人媒体の最適化',
                    description: '複数の求人チャネルを効果的に活用し、応募数を最大化します。',
                    steps: [
                        'ジョブメドレー・グッピーなど歯科専門媒体への掲載',
                        'Indeed・求人ボックスの無料掲載活用',
                        '自院HPの採用ページSEO対策',
                        'ハローワークへの求人登録',
                        '媒体別の応募数・採用数の分析'
                    ],
                    effect: '応募経路 +3チャネル以上',
                    difficulty: '低',
                    period: '効果発現まで約1ヶ月'
                },
                {
                    title: '面接・選考プロセスの改善',
                    description: '応募者に選ばれる医院になるため、選考体験を向上させます。',
                    steps: [
                        '応募から面接まで3日以内のスピード対応',
                        '院内見学の実施で職場の雰囲気を伝える',
                        '面接時の質問リストの標準化',
                        '条件面の明確な提示（給与・休日・福利厚生）',
                        '内定後のフォロー連絡'
                    ],
                    effect: '内定承諾率 +40%',
                    difficulty: '低',
                    period: '即効性あり'
                },
                {
                    title: '学校・養成機関との連携',
                    description: '新卒採用のパイプラインを構築し、安定した人材確保を実現します。',
                    steps: [
                        '近隣の歯科衛生士学校への訪問・PR',
                        '実習生の積極的な受け入れ',
                        '学校の就職説明会への参加',
                        'OB/OG訪問の受け入れ体制整備',
                        '奨学金制度の導入検討'
                    ],
                    effect: '新卒採用 年間+2名以上',
                    difficulty: '中',
                    period: '効果発現まで約6ヶ月'
                }
            ]
        },

        // 業務効率化の提案
        efficiency: {
            title: '業務効率化戦略',
            icon: '⚡',
            items: [
                {
                    title: '予約管理のデジタル化・自動化',
                    description: '受付業務の負担を大幅に軽減し、患者対応の質を向上させます。',
                    steps: [
                        'クラウド型予約管理システムの導入',
                        '患者様自身でのWeb予約・変更の促進',
                        '自動リマインド機能の活用',
                        '予約表のデジタル共有（全スタッフ閲覧可能）',
                        '予約分析レポートの活用'
                    ],
                    effect: '受付業務 -30%の効率化',
                    difficulty: '中',
                    period: '効果発現まで約1ヶ月'
                },
                {
                    title: 'レセプト業務の最適化',
                    description: 'レセプト作成・チェックの効率化で残業時間を削減し、月末の業務負荷を軽減します。',
                    steps: [
                        'レセコンの機能フル活用（自動算定チェック）',
                        '日々のカルテ入力精度向上（後日修正を減らす）',
                        'チェックリストによる確認作業の標準化',
                        '返戻・査定の傾向分析と対策',
                        '電子レセプト請求への完全移行'
                    ],
                    effect: '残業時間の大幅削減（月10時間以上）',
                    difficulty: '中',
                    period: '効果発現まで約2ヶ月'
                },
                {
                    title: '業務マニュアル・SOPの整備',
                    description: '属人化を解消し、誰でも同じ品質で業務を遂行できる体制を構築します。',
                    steps: [
                        '主要業務のフロー図作成',
                        '動画マニュアルの作成（スマホで視聴可能）',
                        'チェックリスト形式での手順書作成',
                        '新人教育での活用と改善フィードバック',
                        '定期的な見直し・更新サイクルの確立'
                    ],
                    effect: '属人化解消でスムーズ運営',
                    difficulty: '中',
                    period: '効果発現まで約2-3ヶ月'
                },
                {
                    title: 'ペーパーレス化・デジタル化の推進',
                    description: '紙の書類を削減し、情報共有と業務効率を向上させます。',
                    steps: [
                        '問診票のタブレット入力化',
                        '同意書・説明書の電子化',
                        'カルテ画像のクラウド保存',
                        'スタッフ間連絡のチャットツール導入',
                        'シフト管理のデジタル化'
                    ],
                    effect: '書類作業 -50%、情報共有速度 3倍',
                    difficulty: '中',
                    period: '効果発現まで約1-2ヶ月'
                }
            ]
        }
    },

    // ========================================
    // パーセンタイル計算用データ（より細かい粒度）
    // 3,247件の成功事例データに基づく分布
    // ========================================
    PERCENTILE_DATA: {
        // 新患数（人/月）: 1%, 5%, 10%, 15%, ... 95%, 99% のパーセンタイル値
        newPatient: [3, 5, 8, 10, 12, 14, 16, 18, 20, 22, 25, 27, 30, 32, 35, 38, 42, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 100, 120, 150],
        // 自費率（%）: より細かい分布
        selfPayRate: [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 17, 19, 21, 24, 27, 30, 33, 36, 40, 45, 50, 55, 60, 65, 70, 80],
        // リコール率（%）: より細かい分布
        recall: [10, 15, 20, 25, 28, 32, 35, 38, 42, 45, 48, 50, 53, 56, 59, 62, 65, 68, 72, 76, 80, 83, 86, 88, 90, 92, 94, 95, 97, 98],
        // キャンセル率（%）: 低い方が良い
        cancel: [15, 13, 12, 11, 10, 9.5, 9, 8.5, 8, 7.5, 7, 6.5, 6, 5.5, 5, 4.5, 4, 3.5, 3, 2.5, 2, 1.8, 1.5, 1.2, 1, 0.8, 0.5, 0.3, 0.2, 0.1],
        // 月商（万円）
        revenue: [200, 250, 300, 350, 400, 450, 500, 550, 600, 650, 700, 750, 800, 850, 900, 950, 1000, 1100, 1200, 1350, 1500, 1700, 2000, 2300, 2600, 3000, 3500, 4000, 5000, 6000]
    },

    // ========================================
    // 地域×規模別ベンチマーク
    // ========================================
    REGIONAL_BENCHMARKS: {
        // 都市部（関東・近畿）
        urban: {
            small: { newPatient: 40, selfPayRate: 20, recall: 55, cancel: 6, revenue: 700 },
            medium: { newPatient: 55, selfPayRate: 25, recall: 60, cancel: 5, revenue: 1000 },
            large: { newPatient: 80, selfPayRate: 30, recall: 65, cancel: 4, revenue: 1500 }
        },
        // 地方都市（東海・中部・九州）
        suburban: {
            small: { newPatient: 30, selfPayRate: 15, recall: 50, cancel: 7, revenue: 550 },
            medium: { newPatient: 45, selfPayRate: 20, recall: 55, cancel: 6, revenue: 800 },
            large: { newPatient: 60, selfPayRate: 25, recall: 60, cancel: 5, revenue: 1200 }
        },
        // 郊外・地方（北海道・東北・中国・四国）
        rural: {
            small: { newPatient: 25, selfPayRate: 12, recall: 55, cancel: 6, revenue: 450 },
            medium: { newPatient: 35, selfPayRate: 16, recall: 58, cancel: 5, revenue: 650 },
            large: { newPatient: 50, selfPayRate: 20, recall: 62, cancel: 4, revenue: 950 }
        }
    },

    // ========================================
    // 開業年数別の期待値
    // ========================================
    YEARS_BENCHMARKS: {
        'under3': {
            expectedGrowth: 'high',
            newPatientMultiplier: 0.7,  // 開業期は新患数がやや低め
            selfPayMultiplier: 0.8,
            focusAreas: ['newPatient', 'efficiency'],
            advice: '開業期は認知度向上と効率的なオペレーション構築が重要です。'
        },
        '3to5': {
            expectedGrowth: 'medium-high',
            newPatientMultiplier: 0.9,
            selfPayMultiplier: 0.9,
            focusAreas: ['selfPay', 'staffRecruitment'],
            advice: '成長期は自費率向上とスタッフ採用が次のステージへの鍵です。'
        },
        '5to10': {
            expectedGrowth: 'medium',
            newPatientMultiplier: 1.0,
            selfPayMultiplier: 1.0,
            focusAreas: ['efficiency', 'cancel'],
            advice: '安定期は既存患者の定着と業務効率化で収益性を高めましょう。'
        },
        '10to20': {
            expectedGrowth: 'low-medium',
            newPatientMultiplier: 1.1,
            selfPayMultiplier: 1.1,
            focusAreas: ['staffRetention', 'efficiency'],
            advice: '成熟期は次世代への引き継ぎとシステム化が重要です。'
        },
        'over20': {
            expectedGrowth: 'stable',
            newPatientMultiplier: 1.0,
            selfPayMultiplier: 1.2,
            focusAreas: ['newPatient', 'efficiency'],
            advice: '長期運営医院は新しい集患方法と設備更新の検討を。'
        }
    },

    // ========================================
    // ユニット数別の規模判定
    // ========================================
    CLINIC_SIZE_THRESHOLDS: {
        small: { min: 1, max: 3 },
        medium: { min: 4, max: 6 },
        large: { min: 7, max: 999 }
    },

    // ========================================
    // 診断結果の詳細分岐条件
    // ========================================
    DIAGNOSIS_CONDITIONS: {
        // 新患獲得力の詳細評価
        newPatientPower: {
            excellent: {
                threshold: 80,
                label: '非常に優秀',
                message: '新患獲得力は業界トップクラスです。この強みを維持しつつ、既存患者の定着に注力しましょう。',
                color: '#10b981'
            },
            good: {
                threshold: 60,
                label: '優秀',
                message: '新患獲得は良好です。さらなる伸びしろがあります。MEO対策やWeb予約の改善で上位を目指せます。',
                color: '#3b82f6'
            },
            average: {
                threshold: 40,
                label: '平均的',
                message: '新患数は平均レベルです。Googleマップ対策とホームページ改善で差別化を図りましょう。',
                color: '#f59e0b'
            },
            belowAverage: {
                threshold: 20,
                label: '改善余地あり',
                message: '新患獲得に課題があります。Web集患の基本（MEO・SEO・SNS）から見直すことをお勧めします。',
                color: '#f97316'
            },
            needsImprovement: {
                threshold: 0,
                label: '要改善',
                message: '新患獲得が急務です。まずはGoogleビジネスプロフィールの最適化から始めましょう。',
                color: '#ef4444'
            }
        },
        // 自費転換力の詳細評価
        selfPayPower: {
            excellent: {
                threshold: 80,
                label: '非常に優秀',
                message: '自費転換力は非常に高いです。この実績を症例として活用し、さらなる価値提供を。',
                color: '#10b981'
            },
            good: {
                threshold: 60,
                label: '優秀',
                message: '自費率は良好です。カウンセリング強化でさらに伸ばせる可能性があります。',
                color: '#3b82f6'
            },
            average: {
                threshold: 40,
                label: '平均的',
                message: '自費率は平均的です。説明ツールの改善とスタッフ研修で改善が見込めます。',
                color: '#f59e0b'
            },
            belowAverage: {
                threshold: 20,
                label: '改善余地あり',
                message: '自費転換に課題があります。患者様への価値伝達方法を見直しましょう。',
                color: '#f97316'
            },
            needsImprovement: {
                threshold: 0,
                label: '要改善',
                message: '自費率向上が収益改善の鍵です。まずはメニュー表と説明資料の整備から。',
                color: '#ef4444'
            }
        },
        // 患者定着率の詳細評価
        patientRetention: {
            excellent: {
                threshold: 80,
                label: '非常に優秀',
                message: '患者定着率は業界トップクラス。この強みを活かした口コミ紹介の促進を。',
                color: '#10b981'
            },
            good: {
                threshold: 60,
                label: '優秀',
                message: '患者定着は良好です。リコールシステムの更なる最適化で上位を目指せます。',
                color: '#3b82f6'
            },
            average: {
                threshold: 40,
                label: '平均的',
                message: '定着率は平均的です。キャンセル対策とリコール強化で改善余地があります。',
                color: '#f59e0b'
            },
            belowAverage: {
                threshold: 20,
                label: '改善余地あり',
                message: '患者定着に課題があります。予約リマインドとフォロー体制の構築を。',
                color: '#f97316'
            },
            needsImprovement: {
                threshold: 0,
                label: '要改善',
                message: '患者離れを防ぐことが急務です。まずはキャンセル対策から始めましょう。',
                color: '#ef4444'
            }
        }
    },

    // ========================================
    // 複合評価マトリクス（新患×自費率）
    // ========================================
    COMPOUND_EVALUATION: {
        // 新患多い × 自費率高い → 理想的な成長医院
        highHigh: {
            label: '成長型優良医院',
            advice: '理想的な状態です。この勢いを維持し、スタッフ定着と業務効率化に注力しましょう。',
            priority: ['staffRetention', 'efficiency']
        },
        // 新患多い × 自費率低い → 自費転換の機会大
        highLow: {
            label: '集患力活用型',
            advice: '新患獲得力があります。自費カウンセリングの強化で大幅な収益改善が見込めます。',
            priority: ['selfPay', 'cancel']
        },
        // 新患少ない × 自費率高い → 安定志向医院
        lowHigh: {
            label: '高単価安定型',
            advice: '質の高い医療を提供されています。新規集患を強化すれば更なる成長が可能です。',
            priority: ['newPatient', 'efficiency']
        },
        // 新患少ない × 自費率低い → 抜本的改善必要
        lowLow: {
            label: '成長課題型',
            advice: '集患と自費率、両面での改善が必要です。まずは新患獲得から着手することをお勧めします。',
            priority: ['newPatient', 'selfPay']
        }
    },

    // ========================================
    // Gemini API設定
    // ========================================
    GEMINI_CONFIG: {
        model: 'gemini-1.5-flash',
        maxOutputTokens: 2048,
        temperature: 0.7
    },

    // ========================================
    // ヘルパー関数
    // ========================================

    /**
     * パーセンタイルを計算（より精密な値を返す）
     * 線形補間を使用して、データポイント間の値も正確に計算
     */
    calculatePercentile(value, dataArray) {
        const sorted = [...dataArray].sort((a, b) => a - b);
        const n = sorted.length;

        // 最小値未満の場合
        if (value <= sorted[0]) {
            // 最小でも5%として計算（線形補間）
            const ratio = Math.max(0, value / sorted[0]);
            return Math.round(ratio * (100 / n) * 10) / 10;
        }

        // 最大値以上の場合
        if (value >= sorted[n - 1]) {
            // 最大でも99.9%を上限とする
            const excess = (value - sorted[n - 1]) / sorted[n - 1];
            const percentile = 95 + Math.min(4.9, excess * 10);
            return Math.round(percentile * 10) / 10;
        }

        // 中間値の場合、線形補間
        for (let i = 0; i < n - 1; i++) {
            if (value >= sorted[i] && value < sorted[i + 1]) {
                const lowerPercentile = ((i + 1) / n) * 100;
                const upperPercentile = ((i + 2) / n) * 100;
                const ratio = (value - sorted[i]) / (sorted[i + 1] - sorted[i]);
                const percentile = lowerPercentile + ratio * (upperPercentile - lowerPercentile);
                return Math.round(percentile * 10) / 10;
            }
        }

        return Math.round((n / n) * 100 * 10) / 10;
    },

    /**
     * 入力値から指標レベルを判定（critical/low/average/good）
     */
    getMetricLevel(value, metricType) {
        const thresholds = this.METRIC_THRESHOLDS[metricType];
        if (!thresholds) return 'average';

        // キャンセル率は低いほど良い（逆転ロジック）
        if (metricType === 'cancel') {
            if (value <= thresholds.excellent) return 'good';
            if (value <= thresholds.good) return 'average';
            if (value <= thresholds.average) return 'low';
            if (value <= thresholds.low) return 'critical';
            return 'critical';
        }

        // 通常の指標（高いほど良い）
        if (value >= thresholds.excellent) return 'good';
        if (value >= thresholds.good) return 'average';
        if (value >= thresholds.average) return 'low';
        if (value >= thresholds.low) return 'critical';
        return 'critical';
    },

    /**
     * 医業収入規模を判定
     */
    getRevenueScale(monthlyRevenue) {
        if (!monthlyRevenue) return null;

        for (const [key, scale] of Object.entries(this.REVENUE_SCALE_PRIORITIES)) {
            if (monthlyRevenue >= scale.range.min && monthlyRevenue < scale.range.max) {
                return { key, ...scale };
            }
        }
        return null;
    },

    /**
     * 関連する成功事例を取得
     */
    getRelevantSuccessCase(priority) {
        const cases = this.SUCCESS_CASES[priority];
        if (!cases || cases.length === 0) return null;

        // ランダムに1〜2件を選択
        const shuffled = [...cases].sort(() => Math.random() - 0.5);
        return shuffled.slice(0, 2);
    },

    /**
     * 課題に応じた提案を取得（改善版：数値に基づく分岐）
     */
    getRecommendations(priority, formData) {
        // 優先度に対応する指標を特定
        const priorityToMetric = {
            newPatient: 'newPatient',
            selfPay: 'selfPayRate',
            cancel: 'cancel',
            staffRetention: null,  // 数値指標なし
            staffRecruitment: null, // 数値指標なし
            efficiency: null       // 数値指標なし
        };

        const metricType = priorityToMetric[priority];
        let metricLevel = 'average';  // デフォルト
        let metricValue = null;

        // 数値指標がある場合、レベルを判定
        if (metricType && formData[metricType] !== undefined) {
            metricValue = parseFloat(formData[metricType]);
            metricLevel = this.getMetricLevel(metricValue, metricType);
        } else if (priority === 'cancel' && formData.cancel !== undefined) {
            metricValue = parseFloat(formData.cancel);
            metricLevel = this.getMetricLevel(metricValue, 'cancel');
        }

        // DETAILED_TACTICSから該当レベルの施策を取得
        const detailedTactics = this.DETAILED_TACTICS[priority];
        let tactics = [];

        if (detailedTactics && detailedTactics[metricLevel]) {
            tactics = detailedTactics[metricLevel];
        } else if (detailedTactics) {
            // フォールバック: 利用可能なレベルから取得
            const levels = ['critical', 'low', 'average', 'good'];
            for (const level of levels) {
                if (detailedTactics[level] && detailedTactics[level].length > 0) {
                    tactics = detailedTactics[level];
                    break;
                }
            }
        }

        // 関連する成功事例を取得
        const successCases = this.getRelevantSuccessCase(priority);

        // 医業収入規模を取得
        const revenueScale = this.getRevenueScale(formData.monthlyRevenue);

        // 地域特性を取得
        let regionalNote = null;
        if (formData.region && this.REGIONAL_DATA[formData.region]) {
            const regional = this.REGIONAL_DATA[formData.region];
            if (regional.competition === 'high' && priority === 'newPatient') {
                regionalNote = '競合の多い地域のため、差別化戦略が特に重要です。';
            } else if (regional.competition === 'low') {
                regionalNote = '競合が少ない地域のため、基本的な集患施策で効果が出やすいです。';
            }
        }

        // 開業年数に基づくアドバイス
        let yearsNote = null;
        if (formData.yearsOpen && this.YEARS_DATA[formData.yearsOpen]) {
            const yearsData = this.YEARS_DATA[formData.yearsOpen];
            if (yearsData.phase === 'growth') {
                yearsNote = '成長期の医院には特に効果的な施策です。';
            } else if (yearsData.phase === 'mature') {
                yearsNote = '安定期の医院では、既存患者のLTV向上がカギとなります。';
            }
        }

        // tactics を recommendations形式に変換
        const customizedItems = tactics.map(tactic => ({
            title: tactic.title,
            description: tactic.description,
            steps: tactic.steps || [],
            effect: tactic.effect,
            difficulty: tactic.difficulty,
            period: tactic.period,
            cost: tactic.cost,
            priority: tactic.priority,
            additionalNote: regionalNote,
            priorityNote: yearsNote
        }));

        // 既存のRECOMMENDATIONSから基本情報を取得
        const baseRecommendations = this.RECOMMENDATIONS[priority];
        const title = baseRecommendations ? baseRecommendations.title : this.getPriorityTitle(priority);
        const description = baseRecommendations ? baseRecommendations.description : '';

        return {
            title: title,
            description: description,
            items: customizedItems,
            metricLevel: metricLevel,
            metricValue: metricValue,
            successCases: successCases,
            revenueScale: revenueScale,
            levelDescription: this.getLevelDescription(priority, metricLevel, metricValue)
        };
    },

    /**
     * 優先度のタイトルを取得
     */
    getPriorityTitle(priority) {
        const titles = {
            newPatient: '新患獲得の強化',
            selfPay: '自費率向上',
            cancel: 'キャンセル率改善',
            staffRetention: 'スタッフ定着率向上',
            staffRecruitment: 'スタッフ採用強化',
            efficiency: '業務効率化'
        };
        return titles[priority] || priority;
    },

    /**
     * レベルに応じた状況説明を生成
     */
    getLevelDescription(priority, level, value) {
        const descriptions = {
            newPatient: {
                critical: `月間新患数${value}人は業界平均を大きく下回っています。まず基本的なMEO対策から着手しましょう。`,
                low: `月間新患数${value}人は改善の余地があります。HP・SEO対策で集患力を強化しましょう。`,
                average: `月間新患数${value}人は平均的な水準です。LP・PPC広告で自費新患を増やすステージです。`,
                good: `月間新患数${value}人は優秀な水準です。紹介と地域連携でさらなる質の向上を目指しましょう。`
            },
            selfPayRate: {
                critical: `自費率${value}%は業界平均を大きく下回っています。カウンセリングの仕組み化が急務です。`,
                low: `自費率${value}%は改善の余地があります。TC育成とカウンセリング強化を進めましょう。`,
                average: `自費率${value}%は平均的な水準です。自費メニューの拡充で次のステージへ。`,
                good: `自費率${value}%は優秀な水準です。高単価メニューの強化でさらなる収益向上を。`
            },
            cancel: {
                critical: `キャンセル率${value}%は経営に大きな影響があります。リマインド・予約管理の改善が急務です。`,
                low: `キャンセル率${value}%は改善の余地があります。チェアサイド予約の徹底を。`,
                average: `キャンセル率${value}%は平均的な水準です。さらなる改善で生産性向上を。`,
                good: `キャンセル率${value}%は良好な水準です。キャンセル待ちリストで稼働率をさらに向上させましょう。`
            },
            staffRetention: {
                critical: 'スタッフの定着に課題があります。まずはコミュニケーションの仕組み化から始めましょう。',
                low: 'スタッフの定着率を上げるため、研修制度と評価制度の整備を進めましょう。',
                average: 'スタッフの定着率は安定しています。キャリアパスの明確化でさらなる向上を。',
                good: 'スタッフの定着率は良好です。チーム力を活かした組織づくりを進めましょう。'
            },
            staffRecruitment: {
                critical: '採用に課題があります。採用チャネルの拡充と職場の魅力発信を強化しましょう。',
                low: '採用を強化するため、学校連携とSNS発信に注力しましょう。',
                average: '採用は安定しています。つながり採用でより質の高い人材確保を。',
                good: '採用は順調です。育成体制を整え、人材の成長を支援しましょう。'
            },
            efficiency: {
                critical: '業務効率に改善の余地があります。まずは業務の可視化から始めましょう。',
                low: '業務効率を上げるため、DXツールの導入を検討しましょう。',
                average: '業務効率は平均的です。さらなる自動化で生産性向上を。',
                good: '業務効率は良好です。時短診療や働き方改革を進めるステージです。'
            }
        };

        const priorityDesc = descriptions[priority];
        if (!priorityDesc) return '';

        return priorityDesc[level] || '';
    },

    /**
     * 類似医院との比較データを生成（詳細評価付き）
     */
    generateComparison(formData) {
        const comparison = {
            newPatientPower: { percentile: 50, status: 'average', evaluation: null },
            selfPayPower: { percentile: 50, status: 'average', evaluation: null },
            patientRetention: { percentile: 50, status: 'average', evaluation: null },
            compoundEvaluation: null,
            yearsAdvice: null,
            regionalBenchmark: null
        };

        // 新患獲得力
        if (formData.newPatient) {
            comparison.newPatientPower.percentile = this.calculatePercentile(
                formData.newPatient,
                this.PERCENTILE_DATA.newPatient
            );
            comparison.newPatientPower.status = this.getStatus(comparison.newPatientPower.percentile);
            comparison.newPatientPower.evaluation = this.getDetailedEvaluation(
                'newPatientPower',
                comparison.newPatientPower.percentile
            );
        }

        // 自費転換力
        if (formData.selfPayRate) {
            comparison.selfPayPower.percentile = this.calculatePercentile(
                formData.selfPayRate,
                this.PERCENTILE_DATA.selfPayRate
            );
            comparison.selfPayPower.status = this.getStatus(comparison.selfPayPower.percentile);
            comparison.selfPayPower.evaluation = this.getDetailedEvaluation(
                'selfPayPower',
                comparison.selfPayPower.percentile
            );
        }

        // 患者定着率（リコール率とキャンセル率の複合）
        if (formData.recall || formData.cancel) {
            let recallPercentile = 50;
            let cancelPercentile = 50;

            if (formData.recall) {
                recallPercentile = this.calculatePercentile(
                    formData.recall,
                    this.PERCENTILE_DATA.recall
                );
            }

            if (formData.cancel) {
                // キャンセル率は低い方が良いので、逆順で計算
                const cancelData = this.PERCENTILE_DATA.cancel;
                // キャンセル率が低いほど高いパーセンタイル
                if (formData.cancel <= cancelData[cancelData.length - 1]) {
                    cancelPercentile = 99;
                } else if (formData.cancel >= cancelData[0]) {
                    cancelPercentile = 1;
                } else {
                    // 線形補間
                    for (let i = 0; i < cancelData.length - 1; i++) {
                        if (formData.cancel <= cancelData[i] && formData.cancel > cancelData[i + 1]) {
                            const ratio = (cancelData[i] - formData.cancel) / (cancelData[i] - cancelData[i + 1]);
                            cancelPercentile = ((i + 1 + ratio) / cancelData.length) * 100;
                            break;
                        }
                    }
                }
            }

            // リコール率とキャンセル率を加重平均
            comparison.patientRetention.percentile = Math.round(
                (recallPercentile * 0.6 + cancelPercentile * 0.4) * 10
            ) / 10;
            comparison.patientRetention.status = this.getStatus(comparison.patientRetention.percentile);
            comparison.patientRetention.evaluation = this.getDetailedEvaluation(
                'patientRetention',
                comparison.patientRetention.percentile
            );
        }

        // 複合評価（新患×自費率マトリクス）
        if (formData.region && formData.units) {
            comparison.compoundEvaluation = this.getCompoundEvaluation(formData);
            comparison.regionalBenchmark = this.getRegionalBenchmark(formData.region, formData.units);
        }

        // 開業年数別アドバイス
        if (formData.yearsOpen) {
            comparison.yearsAdvice = this.getYearsAdvice(formData.yearsOpen);
        }

        return comparison;
    },

    getStatus(percentile) {
        if (percentile >= 80) return 'excellent';
        if (percentile >= 60) return 'good';
        if (percentile >= 40) return 'average';
        if (percentile >= 20) return 'belowAverage';
        return 'needsImprovement';
    },

    /**
     * 詳細な評価結果を取得
     */
    getDetailedEvaluation(metric, percentile) {
        const conditions = this.DIAGNOSIS_CONDITIONS[metric];
        if (!conditions) return null;

        for (const [level, config] of Object.entries(conditions)) {
            if (percentile >= config.threshold) {
                return {
                    level: level,
                    label: config.label,
                    message: config.message,
                    color: config.color,
                    percentile: percentile
                };
            }
        }
        return conditions.needsImprovement;
    },

    /**
     * 地域タイプを判定
     */
    getRegionType(region) {
        const urbanRegions = ['kanto', 'kinki'];
        const suburbanRegions = ['tokai', 'chubu', 'kyushu'];

        if (urbanRegions.includes(region)) return 'urban';
        if (suburbanRegions.includes(region)) return 'suburban';
        return 'rural';
    },

    /**
     * 医院規模を判定
     */
    getClinicSize(units) {
        const unitNum = parseInt(units) || 3;
        if (unitNum <= this.CLINIC_SIZE_THRESHOLDS.small.max) return 'small';
        if (unitNum <= this.CLINIC_SIZE_THRESHOLDS.medium.max) return 'medium';
        return 'large';
    },

    /**
     * 地域×規模別のベンチマークを取得
     */
    getRegionalBenchmark(region, units) {
        const regionType = this.getRegionType(region);
        const clinicSize = this.getClinicSize(units);
        return this.REGIONAL_BENCHMARKS[regionType][clinicSize];
    },

    /**
     * 複合評価を取得（新患×自費率マトリクス）
     */
    getCompoundEvaluation(formData) {
        const benchmark = this.getRegionalBenchmark(formData.region, formData.units);

        const newPatientHigh = (formData.newPatient || 0) >= benchmark.newPatient;
        const selfPayHigh = (formData.selfPayRate || 0) >= benchmark.selfPayRate;

        if (newPatientHigh && selfPayHigh) return this.COMPOUND_EVALUATION.highHigh;
        if (newPatientHigh && !selfPayHigh) return this.COMPOUND_EVALUATION.highLow;
        if (!newPatientHigh && selfPayHigh) return this.COMPOUND_EVALUATION.lowHigh;
        return this.COMPOUND_EVALUATION.lowLow;
    },

    /**
     * 開業年数別のアドバイスを取得
     */
    getYearsAdvice(yearsOpen) {
        return this.YEARS_BENCHMARKS[yearsOpen] || this.YEARS_BENCHMARKS['5to10'];
    },

    /**
     * 調整済みパーセンタイルを計算（地域・規模・開業年数を考慮）
     */
    calculateAdjustedPercentile(value, metric, formData) {
        const basePercentile = this.calculatePercentile(value, this.PERCENTILE_DATA[metric] || []);

        // 開業年数による調整
        const yearsData = this.YEARS_BENCHMARKS[formData.yearsOpen];
        let multiplier = 1;
        if (yearsData) {
            if (metric === 'newPatient') multiplier = yearsData.newPatientMultiplier;
            if (metric === 'selfPayRate') multiplier = yearsData.selfPayMultiplier;
        }

        // 地域・規模による調整
        const benchmark = this.getRegionalBenchmark(formData.region, formData.units);
        const nationalAvg = this.INDUSTRY_BENCHMARKS[metric]?.average || 0;
        const regionalAvg = benchmark[metric] || nationalAvg;

        // 地域平均が全国平均より低い場合、相対的に評価を上げる
        const regionalAdjustment = nationalAvg > 0 ? regionalAvg / nationalAvg : 1;

        // 調整後のパーセンタイル
        const adjustedPercentile = basePercentile * multiplier / regionalAdjustment;

        // 0-100の範囲に収める
        return Math.min(99.9, Math.max(0.1, adjustedPercentile));
    },

    /**
     * 類似医院数を推定
     */
    estimateSimilarClinics(formData) {
        let baseCount = 3247;
        let filterFactor = 1;

        if (formData.region) filterFactor *= 0.11;
        if (formData.yearsOpen) filterFactor *= 0.2;
        if (formData.units) filterFactor *= 0.125;
        if (formData.insurance || formData.selfPay) filterFactor *= 0.15;

        return Math.max(10, Math.floor(baseCount * filterFactor));
    },

    /**
     * Gemini API用のプロンプトを生成
     */
    generateGeminiPrompt(formData, priority) {
        const priorityLabels = {
            newPatient: '新患獲得',
            selfPay: '自費率向上',
            cancel: 'キャンセル削減',
            staffRetention: 'スタッフ定着',
            staffRecruitment: 'スタッフ採用',
            efficiency: '業務効率化'
        };

        return `あなたは歯科医院経営の専門コンサルタントです。以下の歯科医院のデータを分析し、${priorityLabels[priority] || '経営改善'}に関する具体的なアドバイスを提供してください。

## 医院データ
- 地域: ${formData.region || '未入力'}
- 開業年数: ${formData.yearsOpen || '未入力'}
- ユニット数: ${formData.units || '未入力'}台
- 月間新患数: ${formData.newPatient || '未入力'}人
- 1日平均来院数: ${formData.dailyVisit || '未入力'}人
- 月間保険収入: ${formData.insurance || '未入力'}万円
- 月間自費収入: ${formData.selfPay || '未入力'}万円
- キャンセル率: ${formData.cancel || '未入力'}%
- リコール率: ${formData.recall || '未入力'}%
- レセプト枚数: ${formData.receipt || '未入力'}枚/月
- その他の悩み: ${formData.otherConcerns || 'なし'}

## 回答形式
以下の形式で回答してください：

1. **現状分析**（100字程度）
   - データから読み取れる強みと課題

2. **優先すべき改善施策**（3つ）
   各施策について：
   - タイトル
   - 具体的な実行ステップ（3-5ステップ）
   - 期待される効果
   - 実行の難易度（低/中/高）

3. **短期的に着手すべきこと**（今週からできること）

回答は具体的で実行可能な内容にしてください。`;
    }
};

// グローバルに公開
window.KnowledgeBase = KnowledgeBase;
